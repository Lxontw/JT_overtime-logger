<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G16K åŠ ç­ç™»è¨˜</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 20px 10px; display: flex; justify-content: center; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { text-align: center; margin: 0 0 20px 0; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background: #007bff; }
        .btn-secondary { background: #6c757d; }
        .ocr-btn { background: #6f42c1; padding: 5px 10px; font-size: 12px; border-radius: 4px; border: none; color: white; cursor: pointer; float: right; }

        /* æ¨¡å¼åˆ‡æ› Tabs */
        .mode-tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #e9ecef; padding: 4px; border-radius: 8px; }
        .mode-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 14px; color: #666; }
        .mode-tab.active { background: white; color: #007bff; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* éš±è—å…ƒç´  */
        .hidden { display: none !important; }
        
        /* è£åˆ‡è¦–çª— */
        #cropModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 999; display: flex; flex-direction: column; }
        .crop-area { flex: 1; overflow: hidden; position: relative; }
        .crop-actions { padding: 15px; background: white; display: flex; gap: 10px; }
        
        /* è¨Šæ¯ */
        .msg { padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; display: none; }
        .msg.success { background: #d4edda; color: #155724; }
        .msg.error { background: #f8d7da; color: #721c24; }
        
        .settings-icon { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; opacity: 0.5; }
    </style>
</head>
<body>

<div id="cropModal" class="hidden">
    <div class="crop-area"><img id="imageToCrop" style="max-width: 100%;"></div>
    <div class="crop-actions">
        <button class="btn btn-secondary" onclick="closeCrop()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="doOCR()">ç¢ºèªä¸¦è¾¨è­˜</button>
    </div>
</div>

<div class="container" style="position: relative;">
    <div class="settings-icon" onclick="toggleSettings()">âš™ï¸</div>
    
    <div id="setupPanel" class="hidden">
        <h2>ç³»çµ±è¨­å®š</h2>
        <div class="form-group">
            <label>GAS ç¶²å€ (æ‚¨çš„ API)</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxx/exec">
        </div>
        <div class="form-group">
            <label>æ¨™æº–ä¸Šç­æ™‚é–“ (èµ·å§‹)</label>
            <input type="time" id="stdStartTime" value="08:30">
        </div>
        <div class="form-group">
            <label>æ¨™æº–ä¸‹ç­æ™‚é–“ (èµ·å§‹)</label>
            <input type="time" id="stdOffTime" value="17:30">
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">å„²å­˜ä¸¦è¿”å›</button>
    </div>

    <div id="mainPanel">
        <h2>G16K åŠ ç­ç™»è¨˜</h2>
        
        <div class="form-group">
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" required>
        </div>

        <div class="mode-tabs">
            <div class="mode-tab active" onclick="setMode('regular')">å¸¸è¦ä¸‹ç­</div>
            <div class="mode-tab" onclick="setMode('overtime')">ç‰¹å®šåŠ ç­</div>
            <div class="mode-tab" onclick="setMode('special')">ç‰¹æ®Šæ™‚æ®µ</div>
        </div>

        <form id="otForm">
            <input type="hidden" id="name" name="name">

            <div class="form-group" id="startTimeGroup" class="hidden">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="time" id="startTime">
            </div>

            <div class="form-group">
                <label>çµæŸæ™‚é–“</label>
                <input type="time" id="endTime" required>
            </div>

            <div class="form-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <label style="margin:0;">åŠ ç­äº‹ç”±</label>
                    <button type="button" class="ocr-btn" onclick="document.getElementById('fileIn').click()">ğŸ“· OCR</button>
                </div>
                <input type="file" id="fileIn" accept="image/*" hidden onchange="openCrop(this)">
                
                <select id="reasonSelect" onchange="this.value ? document.getElementById('reason').value=this.value : null" style="margin-bottom:8px;">
                    <option value="" selected disabled>-- å¿«é€Ÿé¸æ“‡ --</option>
                    <option value="äº¤æ¥è¼ªå€¼">éƒ¨é–€æœƒè­°</option>
                    <option value="ç™¾è²¨é¡è™•ç†">éƒ¨é–€æœƒè­°</option>
                    <option value="æ•™ç§‘æ›¸è™•ç†">éƒ¨é–€æœƒè­°</option>
                    <option value="æ•¸ä½å°åˆ·">å°ˆæ¡ˆè¶•å·¥</option>
                    <option value="è‡¨æ™‚æ€¥ä»¶">éƒ¨é–€æœƒè­°</option>
                </select>
                <textarea id="reason" rows="2" placeholder="è¼¸å…¥äº‹ç”±..." required></textarea>
                <div id="ocrStatus" style="font-size:12px; color:#6f42c1; margin-top:5px;"></div>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary">é€å‡ºç™»è¨˜</button>
        </form>
        
        <div id="msgBox" class="msg"></div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–
    const els = {
        setup: document.getElementById('setupPanel'), main: document.getElementById('mainPanel'),
        apiUrl: document.getElementById('apiUrl'), stdStart: document.getElementById('stdStartTime'), stdOff: document.getElementById('stdOffTime'),
        date: document.getElementById('date'), startTime: document.getElementById('startTime'), endTime: document.getElementById('endTime'),
        startGroup: document.getElementById('startTimeGroup'), reason: document.getElementById('reason'),
        submitBtn: document.getElementById('submitBtn'), msg: document.getElementById('msgBox'),
        imageToCrop: document.getElementById('imageToCrop'), cropModal: document.getElementById('cropModal'),
        ocrStatus: document.getElementById('ocrStatus')
    };
    
    let cropper = null;
    let currentMode = 'regular';

    // å•Ÿå‹•è¼‰å…¥
    window.onload = () => {
        els.date.valueAsDate = new Date();
        loadConfig();
        if(!els.apiUrl.value) toggleSettings(); // æ²’è¨­å®šå°±é–‹è¨­å®šé 
        setMode('regular'); // é è¨­å¸¸è¦æ¨¡å¼
    };

    // --- è¨­å®šèˆ‡å¤šç”¨æˆ¶é‚è¼¯ ---
    function loadConfig() {
        els.apiUrl.value = localStorage.getItem('gas_url') || '';
        els.stdStart.value = localStorage.getItem('std_start') || '08:30';
        els.stdOff.value = localStorage.getItem('std_off') || '17:30';
    }
    
    function saveConfig() {
        const url = els.apiUrl.value.trim();
        if(!url) return alert('è«‹è¼¸å…¥ GAS ç¶²å€');
        localStorage.setItem('gas_url', url);
        localStorage.setItem('std_start', els.stdStart.value);
        localStorage.setItem('std_off', els.stdOff.value);
        toggleSettings();
    }

    function toggleSettings() {
        const isMain = els.main.style.display !== 'none';
        els.main.style.display = isMain ? 'none' : 'block';
        els.setup.classList.toggle('hidden', isMain);
    }

    // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    window.setMode = function(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        if (mode === 'regular') {
            // å¸¸è¦ï¼šèµ·å§‹æ™‚é–“éš±è—ï¼Œä½¿ç”¨æ¨™æº–ä¸‹ç­æ™‚é–“ä½œç‚ºèµ·å§‹
            els.startGroup.classList.add('hidden');
            els.startTime.value = els.stdOff.value; 
        } else if (mode === 'overtime') {
            // ç‰¹å®šåŠ ç­ï¼šèµ·å§‹æ™‚é–“é¡¯ç¤ºï¼Œé è¨­ç‚ºæ¨™æº–ä¸‹ç­æ™‚é–“ (å¯æ”¹)
            els.startGroup.classList.remove('hidden');
            els.startTime.value = els.stdOff.value;
        } else if (mode === 'special') {
            // ç‰¹æ®Šæ™‚æ®µï¼šèµ·å§‹æ™‚é–“é¡¯ç¤ºï¼Œé è¨­ç‚ºç©ºæˆ–æ¨™æº–ä¸Šç­æ™‚é–“
            els.startGroup.classList.remove('hidden');
            els.startTime.value = els.stdStart.value;
        }
    };

    // --- è¡¨å–®é€å‡º ---
    document.getElementById('otForm').onsubmit = (e) => {
        e.preventDefault();
        const url = localStorage.getItem('gas_url');
        if(!url) return alert('è«‹å…ˆè¨­å®š API ç¶²å€');

        showMsg('å‚³é€ä¸­...', '');
        els.submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('action', 'submit');
        formData.append('date', els.date.value);
        formData.append('startTime', els.startTime.value);
        formData.append('endTime', els.endTime.value);
        formData.append('reason', els.reason.value);
        formData.append('name', 'User'); // GASç«¯è‹¥éœ€è¦å¯æ“´å……

        fetch(url, { method: 'POST', body: formData })
            .then(r => r.json())
            .then(d => {
                if(d.result === 'success') {
                    showMsg('âœ… ç™»è¨˜æˆåŠŸï¼', 'success');
                    els.reason.value = '';
                } else {
                    showMsg('âŒ éŒ¯èª¤ï¼š' + d.error, 'error');
                }
            })
            .catch(err => showMsg('âŒ ç¶²è·¯éŒ¯èª¤', 'error'))
            .finally(() => els.submitBtn.disabled = false);
    };

    function showMsg(txt, type) {
        els.msg.textContent = txt;
        els.msg.className = 'msg ' + type;
        els.msg.style.display = 'block';
        if(type === 'success') setTimeout(() => els.msg.style.display = 'none', 3000);
    }

    // --- OCR è£åˆ‡èˆ‡è™•ç† ---
    window.openCrop = function(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            els.imageToCrop.src = e.target.result;
            els.cropModal.classList.remove('hidden');
            if(cropper) cropper.destroy();
            cropper = new Cropper(els.imageToCrop, { viewMode: 1 });
        };
        reader.readAsDataURL(input.files[0]);
        input.value = ''; // é‡ç½®
    };

    window.closeCrop = function() {
        els.cropModal.classList.add('hidden');
        if(cropper) cropper.destroy();
    };

    window.doOCR = function() {
        if(!cropper) return;
        els.ocrStatus.textContent = 'è¾¨è­˜ä¸­...';
        const base64 = cropper.getCroppedCanvas({maxWidth: 800}).toDataURL('image/jpeg', 0.7).split(',')[1];
        closeCrop();

        const formData = new FormData();
        formData.append('action', 'ocr');
        formData.append('image', base64);
        
        fetch(localStorage.getItem('gas_url'), { method: 'POST', body: formData })
            .then(r => r.json())
            .then(d => {
                if(d.result === 'success') {
                    els.reason.value = d.text;
                    els.ocrStatus.textContent = 'âœ¨ è¾¨è­˜å®Œæˆ';
                } else {
                    els.ocrStatus.textContent = 'âŒ è¾¨è­˜å¤±æ•—';
                }
            })
            .catch(() => els.ocrStatus.textContent = 'âŒ éŒ¯èª¤');
    };
</script>
</body>
</html>
