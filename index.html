<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åŠ ç­ç™»è¨˜ç³»çµ± (24Hç‰ˆ)</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
        }
        .container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 420px;
            position: relative;
        }
        h2 { text-align: center; color: #333; margin: 0 0 1.5rem 0; font-size: 1.5rem;}
        
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.4rem; color: #555; font-weight: 600; font-size: 0.9rem;}
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, textarea, select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; background: #fff;
            appearance: none;
        }
        input:focus, textarea:focus, select:focus { border-color: #007bff; outline: none; }

        /* æ™‚é–“é¡¯ç¤ºè¼”åŠ©æ–‡å­— */
        .time-hint {
            font-size: 0.85rem; color: #007bff; font-weight: bold; margin-top: 5px; display: block; text-align: right;
        }

        .btn-primary {
            width: 100%; padding: 14px; background-color: #007bff; color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background 0.2s; margin-top: 10px;
        }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .ocr-btn {
            background-color: #6f42c1; color: white; border: none; 
            padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;
            margin-left: auto; display: inline-block;
        }
        .label-row { display: flex; justify-content: space-between; align-items: center; }

        .tabs { display: flex; margin-bottom: 1rem; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .tab {
            flex: 1; text-align: center; padding: 10px; cursor: pointer;
            border-radius: 6px; color: #666; font-weight: 500; transition: 0.3s;
        }
        .tab.active { background: white; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .settings-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: #aaa; cursor: pointer; font-size: 20px; padding: 5px;
        }

        .hidden { display: none; }
        
        .msg { text-align: center; margin-top: 1rem; font-size: 14px; padding: 10px; border-radius: 6px;}
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .loading-ocr { color: #6f42c1; font-size: 12px; margin-top: 5px;}
        #ocrPreview { max-width: 100%; margin-top: 10px; border-radius: 6px; display: none;}
    </style>
</head>
<body>

<div class="container">
    <button class="settings-btn" onclick="showPanel('setupPanel')">âš™ï¸</button>

    <div id="setupPanel" class="hidden">
        <h2>ğŸ› ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="form-group">
            <label>GAS ç¶²å€ (API URL)</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/..." style="font-size: 12px;">
        </div>
        <div class="form-group">
            <label>æ¨™æº–ä¸‹ç­æ™‚é–“ (24å°æ™‚åˆ¶)</label>
            <input type="time" id="stdOffTime" value="17:30" oninput="updateTimeLabel(this, 'stdTimeHint')">
            <span id="stdTimeHint" class="time-hint">24H: 17:30</span>
        </div>
        <div class="form-group">
            <label>å¸¸ç”¨åŠ ç­äº‹ç”± (ç”¨é€—è™Ÿåˆ†éš”)</label>
            <textarea id="commonReasons" rows="3">å°ˆæ¡ˆè¶•å·¥,éƒ¨é–€æœƒè­°,å®¢æˆ¶éœ€æ±‚è™•ç†,ç·Šæ€¥ç¶­ä¿®</textarea>
        </div>
        <button class="btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        <button class="btn-primary" style="background:#6c757d; margin-top:10px;" onclick="showPanel('mainPanel')">è¿”å›</button>
    </div>

    <div id="mainPanel">
        <h2>â° åŠ ç­ç™»è¨˜</h2>
        
        <div class="tabs">
            <div class="tab active" onclick="switchMode('quick')">ğŸš€ å¿«é€Ÿä¸‹ç­</div>
            <div class="tab" onclick="switchMode('custom')">ğŸ› ï¸ è‡ªè¨‚å€é–“</div>
        </div>

        <form id="overtimeForm">
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div id="quickTimeGroup">
                <div class="form-group">
                    <label>åŠ ç­çµæŸæ™‚é–“ (èµ·: <span id="displayStdTime">17:30</span>)</label>
                    <input type="time" id="quickEndTime" oninput="handleQuickTimeChange()">
                    <span id="quickTimeHint" class="time-hint">è«‹é¸æ“‡æ™‚é–“</span>
                </div>
            </div>

            <div id="customTimeGroup" class="hidden">
                <div class="form-group">
                    <label>é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="startTime" name="startTime" oninput="updateTimeLabel(this, 'startHint')">
                    <span id="startHint" class="time-hint">--:--</span>
                </div>
                <div class="form-group">
                    <label>çµæŸæ™‚é–“</label>
                    <input type="time" id="endTime" name="endTime" oninput="updateTimeLabel(this, 'endHint')">
                    <span id="endHint" class="time-hint">--:--</span>
                </div>
            </div>

            <div class="form-group">
                <div class="label-row">
                    <label>åŠ ç­äº‹ç”±</label>
                    <div style="position: relative;">
                        <input type="file" id="ocrInput" accept="image/*" style="display: none;" onchange="handleOCR(this)">
                        <button type="button" class="ocr-btn" onclick="document.getElementById('ocrInput').click()">ğŸ“· æ‹ç…§è¾¨è­˜</button>
                    </div>
                </div>
                
                <select id="reasonSelect" onchange="handleReasonSelect()" style="margin-bottom: 8px;">
                    <option value="" disabled selected>-- é¸æ“‡å¸¸ç”¨äº‹ç”± --</option>
                </select>
                
                <textarea id="reason" name="reason" rows="2" placeholder="è©³ç´°èªªæ˜..." required></textarea>
                <div id="ocrStatus" class="loading-ocr"></div>
                <img id="ocrPreview">
            </div>

            <button type="submit" id="submitBtn" class="btn-primary">é€å‡ºç™»è¨˜</button>
            <div id="message" class="msg" style="display:none;"></div>
        </form>
    </div>
</div>

<script>
    const CONFIG = {
        gasUrl: '',
        stdTime: '17:30',
        reasons: []
    };

    const els = {
        setup: document.getElementById('setupPanel'),
        main: document.getElementById('mainPanel'),
        apiUrl: document.getElementById('apiUrl'),
        stdOffTime: document.getElementById('stdOffTime'),
        stdTimeHint: document.getElementById('stdTimeHint'),
        commonReasons: document.getElementById('commonReasons'),
        form: document.getElementById('overtimeForm'),
        name: document.getElementById('name'),
        date: document.getElementById('date'),
        quickGroup: document.getElementById('quickTimeGroup'),
        customGroup: document.getElementById('customTimeGroup'),
        quickEndTime: document.getElementById('quickEndTime'),
        quickTimeHint: document.getElementById('quickTimeHint'),
        startTime: document.getElementById('startTime'),
        endTime: document.getElementById('endTime'),
        startHint: document.getElementById('startHint'),
        endHint: document.getElementById('endHint'),
        reasonSelect: document.getElementById('reasonSelect'),
        reason: document.getElementById('reason'),
        msg: document.getElementById('message'),
        submitBtn: document.getElementById('submitBtn'),
        displayStdTime: document.getElementById('displayStdTime'),
        ocrStatus: document.getElementById('ocrStatus'),
        ocrPreview: document.getElementById('ocrPreview')
    };

    init();

    function init() {
        loadConfig();
        els.date.valueAsDate = new Date();
        els.name.value = localStorage.getItem('ot_username') || '';
        
        if (!CONFIG.gasUrl) {
            showPanel('setupPanel');
        } else {
            showPanel('mainPanel');
        }
        updateReasonOptions();
    }

    // --- æ™‚é–“é¡¯ç¤ºè¼”åŠ©åŠŸèƒ½ (æ ¸å¿ƒä¿®æ”¹) ---
    // ç„¡è«–ä½¿ç”¨è€…æ‰‹æ©Ÿæ˜¯ 12h é‚„æ˜¯ 24hï¼Œé€™è£¡éƒ½æœƒå¼·åˆ¶æŠ“å– value (HH:mm) é¡¯ç¤ºå‡ºä¾†
    function updateTimeLabel(input, hintId) {
        const hint = document.getElementById(hintId);
        if (input.value) {
            hint.textContent = `24Hç¢ºèª: ${input.value}`;
        } else {
            hint.textContent = '';
        }
    }

    function handleQuickTimeChange() {
        // åŒæ­¥é¡¯ç¤º
        updateTimeLabel(els.quickEndTime, 'quickTimeHint');
        // åŒæ­¥å€¼åˆ°éš±è—çš„ endTime æ¬„ä½
        els.endTime.value = els.quickEndTime.value;
    }

    // --- è¨­å®šåŠŸèƒ½ ---
    function loadConfig() {
        CONFIG.gasUrl = localStorage.getItem('user_gas_url') || '';
        CONFIG.stdTime = localStorage.getItem('user_std_time') || '17:30';
        // æ›´æ–°è¨­å®šç•«é¢çš„æ™‚é–“é¡¯ç¤º
        els.stdOffTime.value = CONFIG.stdTime;
        updateTimeLabel(els.stdOffTime, 'stdTimeHint');

        const savedReasons = localStorage.getItem('user_reasons');
        CONFIG.reasons = savedReasons ? savedReasons.split(',') : ['å°ˆæ¡ˆè¶•å·¥', 'éƒ¨é–€æœƒè­°'];
        
        els.apiUrl.value = CONFIG.gasUrl;
        els.commonReasons.value = CONFIG.reasons.join(',');
        els.displayStdTime.textContent = CONFIG.stdTime;
    }

    function saveSettings() {
        const url = els.apiUrl.value.trim();
        if (!url.startsWith('https://script.google.com/')) {
            alert('ç¶²å€æ ¼å¼éŒ¯èª¤ï¼éœ€ç‚º https://script.google.com/ é–‹é ­');
            return;
        }
        localStorage.setItem('user_gas_url', url);
        localStorage.setItem('user_std_time', els.stdOffTime.value);
        localStorage.setItem('user_reasons', els.commonReasons.value.replace(/ï¼Œ/g, ','));

        loadConfig();
        updateReasonOptions();
        alert('è¨­å®šå·²å„²å­˜ï¼');
        showPanel('mainPanel');
    }

    function showPanel(panelId) {
        els.setup.classList.add('hidden');
        els.main.classList.add('hidden');
        document.getElementById(panelId).classList.remove('hidden');
    }

    function switchMode(mode) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        if (mode === 'quick') {
            els.quickGroup.classList.remove('hidden');
            els.customGroup.classList.add('hidden');
            els.startTime.value = CONFIG.stdTime; // å¼·åˆ¶è¨­ç‚ºæ¨™æº–æ™‚é–“
            els.quickEndTime.required = true;
            els.startTime.required = false;
            els.endTime.required = false;
        } else {
            els.quickGroup.classList.add('hidden');
            els.customGroup.classList.remove('hidden');
            els.quickEndTime.required = false;
            els.startTime.required = true;
            els.endTime.required = true;
            // æ¸…ç©ºæç¤º
            els.startHint.textContent = els.startTime.value ? `24Hç¢ºèª: ${els.startTime.value}` : '';
            els.endHint.textContent = els.endTime.value ? `24Hç¢ºèª: ${els.endTime.value}` : '';
        }
    }

    function updateReasonOptions() {
        els.reasonSelect.innerHTML = '<option value="" disabled selected>-- é¸æ“‡å¸¸ç”¨äº‹ç”± --</option>';
        CONFIG.reasons.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r;
            opt.textContent = r;
            els.reasonSelect.appendChild(opt);
        });
        const clearOpt = document.createElement('option');
        clearOpt.value = "";
        clearOpt.textContent = "âœï¸ æ‰‹å‹•è¼¸å…¥ / æ¸…é™¤";
        els.reasonSelect.appendChild(clearOpt);
    }

    function handleReasonSelect() {
        const val = els.reasonSelect.value;
        if (val) els.reason.value = val;
        else {
            els.reason.value = "";
            els.reason.focus();
        }
    }

    function handleOCR(input) {
        const file = input.files[0];
        if (!file) return;

        els.ocrStatus.textContent = "â³ è®€å–ä¸­... (åˆæ¬¡éœ€ä¸‹è¼‰èªè¨€åŒ…)";
        els.ocrStatus.style.display = "block";
        const reader = new FileReader();
        reader.onload = function(e) {
            els.ocrPreview.src = e.target.result;
            els.ocrPreview.style.display = "block";
        }
        reader.readAsDataURL(file);

        Tesseract.recognize(
            file, 'chi_tra', 
            { logger: m => { if(m.status === 'recognizing text') els.ocrStatus.textContent = `â³ è¾¨è­˜ä¸­... ${(m.progress * 100).toFixed(0)}%`; }}
        ).then(({ data: { text } }) => {
            const cleanText = text.replace(/\s+/g, ' ').trim();
            const currentVal = els.reason.value;
            els.reason.value = currentVal ? currentVal + " " + cleanText : cleanText;
            els.ocrStatus.textContent = "âœ… å®Œæˆï¼";
            setTimeout(() => { els.ocrStatus.style.display = 'none'; els.ocrPreview.style.display = 'none'; }, 3000);
        }).catch(err => {
            els.ocrStatus.textContent = "âŒ å¤±æ•—";
        });
    }

    els.form.addEventListener('submit', e => {
        e.preventDefault();
        
        if (els.customGroup.classList.contains('hidden')) {
            els.startTime.value = CONFIG.stdTime;
            els.endTime.value = els.quickEndTime.value;
        }

        if (!els.startTime.value || !els.endTime.value) {
            alert('è«‹å¡«å¯«å®Œæ•´çš„æ™‚é–“ï¼');
            return;
        }

        els.submitBtn.disabled = true;
        els.submitBtn.textContent = 'å‚³é€ä¸­...';
        els.msg.style.display = 'none';
        localStorage.setItem('ot_username', els.name.value);

        const formData = new FormData(els.form);
        
        fetch(CONFIG.gasUrl, { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.result === 'success') {
                els.msg.textContent = 'âœ… ç™»è¨˜æˆåŠŸï¼';
                els.msg.className = 'msg success';
                els.msg.style.display = 'block';
                els.reason.value = '';
                els.reasonSelect.value = '';
                // ä¸æ¸…ç©ºæ—¥æœŸèˆ‡å§“åï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            els.msg.textContent = 'âŒ éŒ¯èª¤ï¼š' + error.message;
            els.msg.className = 'msg error';
            els.msg.style.display = 'block';
        })
        .finally(() => {
            els.submitBtn.disabled = false;
            els.submitBtn.textContent = 'é€å‡ºç™»è¨˜';
        });
    });
</script>

</body>
</html>
