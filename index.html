<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åŠ ç­ç™»è¨˜ (æ­£å¼ç‰ˆ)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; margin: 0; padding: 20px 0; touch-action: manipulation;
        }
        .container {
            background: white; padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 90%; max-width: 420px; position: relative;
        }
        h2 { text-align: center; color: #333; margin: 0 0 1.5rem 0; font-size: 1.5rem;}
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.4rem; color: #555; font-weight: 600; font-size: 0.9rem;}
        input, textarea, select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; background: #fff; appearance: none;
        }
        .time-hint { font-size: 0.85rem; color: #007bff; font-weight: bold; margin-top: 5px; display: block; text-align: right; }
        .btn-primary, .btn-secondary {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background 0.2s; margin-top: 10px; color: white;
        }
        .btn-primary { background-color: #007bff; } .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; } .btn-secondary:hover { background-color: #5a6268; }
        .ocr-btn { background-color: #6f42c1; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .tabs { display: flex; margin-bottom: 1rem; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 6px; color: #666; font-weight: 500; }
        .tab.active { background: white; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .settings-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; padding: 5px; color: #aaa;}
        .hidden { display: none !important; }
        
        /* è¨Šæ¯æ¡†æ¨£å¼ */
        .msg { 
            text-align: left; margin-top: 1rem; font-size: 14px; padding: 15px; border-radius: 6px; 
            position: relative; word-break: break-all; line-height: 1.5;
        }
        .success { background-color: #d4edda; color: #155724; } 
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .close-msg-btn {
            position: absolute; top: 5px; right: 10px; cursor: pointer;
            background: none; border: none; font-size: 18px; font-weight: bold; opacity: 0.6;
        }
        
        .loading-ocr { color: #6f42c1; font-size: 12px; margin-top: 5px; font-weight: bold;}
        
        /* è£åˆ‡è¦–çª— */
        #cropModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; flex-direction: column; }
        .crop-container { flex: 1; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; background: #333; }
        #imageToCrop { max-width: 100%; max-height: 80vh; display: block; }
        .crop-actions { padding: 15px; background: white; display: flex; gap: 10px; }
    </style>
</head>
<body>

<div id="cropModal" class="hidden">
    <div class="crop-container"><img id="imageToCrop" src=""></div>
    <div class="crop-actions">
        <button type="button" class="btn-secondary" onclick="cancelCrop()">å–æ¶ˆ</button>
        <button type="button" class="btn-primary" onclick="confirmCrop()">âœ¨ AI é›²ç«¯è¾¨è­˜</button>
    </div>
</div>

<div class="container">
    <button class="settings-btn" onclick="showPanel('setupPanel')">âš™ï¸</button>

    <div id="setupPanel" class="hidden">
        <h2>ğŸ› ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="form-group">
            <label>GAS ç¶²å€ (API URL)</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/..." style="font-size: 12px;">
        </div>
        <div class="form-group">
            <label>æ¨™æº–ä¸‹ç­æ™‚é–“</label>
            <input type="time" id="stdOffTime" value="17:30" oninput="updateTimeLabel(this, 'stdTimeHint')">
            <span id="stdTimeHint" class="time-hint">24H: 17:30</span>
        </div>
        <button class="btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        <button class="btn-secondary" onclick="showPanel('mainPanel')">è¿”å›</button>
    </div>

    <div id="mainPanel">
        <h2>â° AI åŠ ç­ç™»è¨˜</h2>
        <div class="tabs">
            <div class="tab active" onclick="switchMode('quick')">ğŸš€ å¿«é€Ÿä¸‹ç­</div>
            <div class="tab" onclick="switchMode('custom')">ğŸ› ï¸ è‡ªè¨‚å€é–“</div>
        </div>

        <form id="overtimeForm">
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div id="quickTimeGroup">
                <div class="form-group">
                    <label>åŠ ç­çµæŸæ™‚é–“ (èµ·: <span id="displayStdTime">17:30</span>)</label>
                    <input type="time" id="quickEndTime" oninput="handleQuickTimeChange()">
                    <span id="quickTimeHint" class="time-hint">è«‹é¸æ“‡æ™‚é–“</span>
                </div>
            </div>

            <div id="customTimeGroup" class="hidden">
                <div class="form-group">
                    <label>é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="startTime" name="startTime" oninput="updateTimeLabel(this, 'startHint')">
                    <span id="startHint" class="time-hint">--:--</span>
                </div>
                <div class="form-group">
                    <label>çµæŸæ™‚é–“</label>
                    <input type="time" id="endTime" name="endTime" oninput="updateTimeLabel(this, 'endHint')">
                    <span id="endHint" class="time-hint">--:--</span>
                </div>
            </div>

            <div class="form-group">
                <div class="label-row" style="margin-bottom: 5px; justify-content: space-between; display:flex; align-items:center;">
                    <label style="margin-bottom: 0;">åŠ ç­äº‹ç”±</label>
                    <input type="file" id="ocrInput" accept="image/*" style="display: none;" onchange="prepareCrop(this)">
                    <button type="button" class="ocr-btn" onclick="document.getElementById('ocrInput').click()">ğŸ“· æ‹ç…§/AI è¾¨è­˜</button>
                </div>
                
                <select id="reasonSelect" onchange="handleReasonSelect()" style="margin-bottom: 8px;">
                    <option value="" disabled selected>-- é¸æ“‡å¸¸ç”¨äº‹ç”± --</option>
                    <option value="å°ˆæ¡ˆè¶•å·¥">å°ˆæ¡ˆè¶•å·¥</option>
                    <option value="éƒ¨é–€æœƒè­°">éƒ¨é–€æœƒè­°</option>
                    <option value="">âœï¸ æ‰‹å‹•è¼¸å…¥</option>
                </select>
                
                <textarea id="reason" name="reason" rows="2" placeholder="è©³ç´°èªªæ˜..." required></textarea>
                <div id="ocrStatus" class="loading-ocr" style="display: none;"></div>
            </div>

            <button type="submit" id="submitBtn" class="btn-primary">é€å‡ºç™»è¨˜</button>
            
            <div id="message" class="msg" style="display:none;">
                <span id="msgText"></span>
                <button type="button" class="close-msg-btn" onclick="closeMsg()">Ã—</button>
            </div>
        </form>
    </div>
</div>

<script>
    const CONFIG = { gasUrl: '', stdTime: '17:30' };
    let cropper = null;

    const els = {
        setup: document.getElementById('setupPanel'), main: document.getElementById('mainPanel'),
        cropModal: document.getElementById('cropModal'), imageToCrop: document.getElementById('imageToCrop'),
        apiUrl: document.getElementById('apiUrl'), stdOffTime: document.getElementById('stdOffTime'),
        form: document.getElementById('overtimeForm'), name: document.getElementById('name'),
        date: document.getElementById('date'), quickGroup: document.getElementById('quickTimeGroup'),
        customGroup: document.getElementById('customTimeGroup'), quickEndTime: document.getElementById('quickEndTime'),
        startTime: document.getElementById('startTime'), endTime: document.getElementById('endTime'),
        reasonSelect: document.getElementById('reasonSelect'), reason: document.getElementById('reason'),
        msg: document.getElementById('message'), msgText: document.getElementById('msgText'),
        submitBtn: document.getElementById('submitBtn'), displayStdTime: document.getElementById('displayStdTime'),
        ocrStatus: document.getElementById('ocrStatus')
    };

    init();

    function init() {
        loadConfig();
        els.date.valueAsDate = new Date();
        els.name.value = localStorage.getItem('ot_username') || '';
        if (!CONFIG.gasUrl) showPanel('setupPanel'); else showPanel('mainPanel');
    }

    // --- è¨Šæ¯æ¡†æ§åˆ¶ ---
    function showMsg(text, type) {
        els.msgText.innerHTML = text;
        els.msg.className = 'msg ' + type;
        els.msg.style.display = 'block';
        if (type === 'success') setTimeout(() => { els.msg.style.display = 'none'; }, 3000);
    }
    function closeMsg() { els.msg.style.display = 'none'; }

    // --- OCR åœ–ç‰‡è£åˆ‡èˆ‡å£“ç¸®æµç¨‹ ---
    function prepareCrop(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            els.imageToCrop.src = e.target.result;
            els.cropModal.classList.remove('hidden');
            if(cropper) cropper.destroy();
            cropper = new Cropper(els.imageToCrop, { viewMode: 1, dragMode: 'move', autoCropArea: 0.8 });
        }
        reader.readAsDataURL(file);
        input.value = '';
    }

    function cancelCrop() {
        els.cropModal.classList.add('hidden');
        if(cropper) { cropper.destroy(); cropper = null; }
    }

    function confirmCrop() {
        if (!cropper) return;
        // 1. å‰ç«¯å£“ç¸®ï¼šé™åˆ¶æœ€å¤§å¯¬åº¦ç‚º 800px (ç¢ºä¿å‚³è¼¸å¿«é€Ÿ)
        const canvas = cropper.getCroppedCanvas({ maxWidth: 800 });
        cancelCrop();

        els.ocrStatus.textContent = "ğŸš€ æ­£åœ¨å‚³é€è‡³ AI é›²ç«¯åˆ†æä¸­...";
        els.ocrStatus.style.display = "block";
        closeMsg();

        // 2. è½‰ç‚º Base64
        const base64Data = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];

        // 3. æº–å‚™é€å‡º (Action = ocr)
        const formData = new FormData();
        formData.append('action', 'ocr'); // å‘Šè¨´å¾Œç«¯é€™æ˜¯ OCR è«‹æ±‚
        formData.append('image', base64Data);

        fetch(CONFIG.gasUrl, {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.result === 'success') {
                const currentVal = els.reason.value;
                els.reason.value = currentVal ? currentVal + " " + data.text : data.text;
                els.ocrStatus.textContent = "âœ¨ AI è¾¨è­˜å®Œæˆï¼";
            } else {
                throw new Error(data.error || 'Unknown error');
            }
        })
        .catch(err => {
            console.error(err);
            els.ocrStatus.textContent = "âŒ è¾¨è­˜å¤±æ•—";
            showMsg("<b>è¾¨è­˜å¤±æ•—ï¼š</b><br>" + err.message, "error");
        })
        .finally(() => {
            setTimeout(() => { els.ocrStatus.style.display = 'none'; }, 2000);
        });
    }

    // --- è¡¨å–®æäº¤é‚è¼¯ ---
    els.form.addEventListener('submit', e => {
        e.preventDefault();
        
        // æ™‚é–“æª¢æŸ¥é‚è¼¯
        if (els.customGroup.classList.contains('hidden')) {
            els.startTime.value = CONFIG.stdTime; 
            els.endTime.value = els.quickEndTime.value;
        }
        if (!els.startTime.value || !els.endTime.value) { alert('è«‹å¡«å¯«å®Œæ•´çš„æ™‚é–“ï¼'); return; }
        
        els.submitBtn.disabled = true; 
        els.submitBtn.textContent = 'å‚³é€ä¸­...'; 
        closeMsg();
        
        localStorage.setItem('ot_username', els.name.value);

        // å»ºç«‹ FormData ä¸¦åŠ å…¥ action = submit
        const formData = new FormData(els.form);
        formData.append('action', 'submit'); // å‘Šè¨´å¾Œç«¯é€™æ˜¯å­˜æª”è«‹æ±‚

        fetch(CONFIG.gasUrl, { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.result === 'success') {
                showMsg("âœ… ç™»è¨˜æˆåŠŸï¼å·²å¯«å…¥è©¦ç®—è¡¨ã€‚", "success");
                els.reason.value = ''; els.reasonSelect.value = '';
            } else { throw new Error(data.error); }
        })
        .catch(error => {
            showMsg("âŒ æäº¤éŒ¯èª¤ï¼š<br>" + error.message, "error");
        })
        .finally(() => { 
            els.submitBtn.disabled = false; 
            els.submitBtn.textContent = 'é€å‡ºç™»è¨˜'; 
        });
    });

    // --- è¼”åŠ©åŠŸèƒ½ ---
    function updateTimeLabel(input, hintId) {
        document.getElementById(hintId).textContent = input.value ? `24H: ${input.value}` : '';
    }
    function handleQuickTimeChange() {
        updateTimeLabel(els.quickEndTime, 'quickTimeHint');
        els.endTime.value = els.quickEndTime.value;
    }
    function handleReasonSelect() {
        const val = els.reasonSelect.value;
        if (val) els.reason.value = val; else { els.reason.value = ""; els.reason.focus(); }
    }
    function loadConfig() {
        CONFIG.gasUrl = localStorage.getItem('user_gas_url') || '';
        CONFIG.stdTime = localStorage.getItem('user_std_time') || '17:30';
        els.stdOffTime.value = CONFIG.stdTime;
        els.apiUrl.value = CONFIG.gasUrl;
        els.displayStdTime.textContent = CONFIG.stdTime;
    }
    function saveSettings() {
        const url = els.apiUrl.value.trim();
        if (!url.startsWith('https://script.google.com/')) { alert('ç¶²å€æ ¼å¼éŒ¯èª¤'); return; }
        localStorage.setItem('user_gas_url', url);
        localStorage.setItem('user_std_time', els.stdOffTime.value);
        loadConfig();
        alert('è¨­å®šå·²å„²å­˜ï¼'); showPanel('mainPanel');
    }
    function showPanel(panelId) {
        els.setup.classList.add('hidden'); els.main.classList.add('hidden');
        document.getElementById(panelId).classList.remove('hidden');
    }
    function switchMode(mode) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if (mode === 'quick') {
            els.quickGroup.classList.remove('hidden'); els.customGroup.classList.add('hidden');
            els.quickEndTime.required = true; els.startTime.required = false; els.endTime.required = false;
        } else {
            els.quickGroup.classList.add('hidden'); els.customGroup.classList.remove('hidden');
            els.quickEndTime.required = false; els.startTime.required = true; els.endTime.required = true;
        }
    }
</script>
</body>
</html>
