<!-- //0130  -->
<!-- åç¨±è®Šæ›´èˆ‡UIé¢¨æ ¼èˆ‡ä»‹é¢å„ªåŒ– -->
<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ ç­è¨˜éŒ„å™¨</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        :root {
            --base-font-size: 16px;
            --bg-color: #f8fafc;
            --container-bg: #ffffff;
            --text-color: #1e293b;
            --label-color: #64748b;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --accent-shadow: rgba(79, 70, 229, 0.15);
            --tab-bg: #f1f5f9;
            --tab-active-bg: #ffffff;
            --tab-active-color: #4f46e5;
            --primary-btn-bg: linear-gradient(135deg, #4f46e5, #4338ca);
            --secondary-btn-bg: #94a3b8;
            --ocr-btn-bg: #7c3aed;
            --success-color: #10b981;
            --error-color: #ef4444;
            --border-radius: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --container-bg: #1e293b;
            --text-color: #f8fafc;
            --label-color: #94a3b8;
            --border-color: #334155;
            --input-bg: #0f172a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --tab-bg: #0f172a;
            --tab-active-bg: #1e293b;
            --tab-active-color: #818cf8;
        }

        * { box-sizing: border-box; }
        html { font-size: var(--base-font-size); }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 15px; transition: background-color 0.3s;
        }

        .container {
            background-color: var(--container-bg);
            width: 100%; max-width: 420px; padding: 28px;
            border-radius: var(--border-radius);
            box-shadow: 0 20px 25px -5px var(--shadow-color);
            position: relative; max-height: 95vh; overflow-y: auto;
        }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        h2 { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--tab-active-color); }

        .view { animation: fadeIn 0.3s ease-out; }
        .hidden { display: none !important; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mode-tabs { display: flex; background-color: var(--tab-bg); padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .mode-tab {
            flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px;
            font-size: 0.85rem; font-weight: 600; color: var(--label-color); transition: var(--transition);
        }
        .mode-tab.active { background-color: var(--tab-active-bg); color: var(--tab-active-color); box-shadow: 0 2px 4px var(--shadow-color); }

        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-size: 0.8rem; font-weight: 700; color: var(--label-color); text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1.5px solid var(--border-color);
            border-radius: 8px; background-color: var(--input-bg); color: var(--text-color);
            font-size: 1rem; transition: var(--transition);
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--tab-active-color); box-shadow: 0 0 0 3px var(--accent-shadow); }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition);
        }
        .btn-primary { background: var(--primary-btn-bg); color: white; }
        .btn-secondary { background-color: var(--secondary-btn-bg); color: white; width: auto; padding: 8px 14px; font-size: 0.75rem; }
        .btn-ocr { background-color: var(--ocr-btn-bg); color: white; margin-top: 8px; font-size: 0.9rem; padding: 10px; }

        .bottom-controls { display: flex; justify-content: center; gap: 8px; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .msg { padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; display: none; text-align: center; font-weight: 600; }
        .msg.success { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); border: 1px solid var(--success-color); }
        .msg.error { background-color: rgba(239, 68, 68, 0.1); color: var(--error-color); border: 1px solid var(--error-color); }

        /* Font Slider Styling */
        .slider-group { margin-bottom: 20px; padding: 0 5px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 600; color: var(--label-color); margin-bottom: 6px; }
        input[type="range"] { -webkit-appearance: none; width: 100%; background: var(--tab-bg); height: 6px; border-radius: 3px; outline: none; padding: 0; border: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: var(--tab-active-color); cursor: pointer; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        #cropModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 999; display: flex; flex-direction: column; }
        .crop-footer { padding: 15px; background: var(--container-bg); display: flex; gap: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div id="mainView" class="view">
        <header>
            <h2>åŠ ç­è¨˜éŒ„å™¨</h2>
            <div class="mode-tabs" style="margin: 0; padding: 3px; min-width: 130px; margin-bottom: 0;">
                <div class="mode-tab active" id="theme-light" onclick="setTheme('light')">â˜€ï¸ äº®è‰²</div>
                <div class="mode-tab" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ æ·±è‰²</div>
            </div>
        </header>

        <div class="slider-group">
            <div class="slider-header"><span>ä»‹é¢å­—é«”å¤§å°</span><span id="fontSizeVal">16px</span></div>
            <input type="range" id="fontSizeSlider" min="12" max="24" value="16" oninput="updateFontSize(this.value)">
        </div>

        <div id="msg" class="msg"></div>

        <form id="otForm" onsubmit="handleSubmit(event)">
            <div class="form-group">
                <label for="date">æ—¥æœŸ</label>
                <input type="date" id="date" required>
            </div>

            <div id="subModeSection">
                <div id="subModeTabs" class="mode-tabs">
                    <div class="mode-tab active" id="mode-regular" onclick="setMode('regular')">å¸¸è¦ä¸‹ç­</div>
                    <div class="mode-tab" id="mode-overtime" onclick="setMode('overtime')">ç‰¹å®šåŠ ç­</div>
                    <div class="mode-tab" id="mode-special" onclick="setMode('special')">ç‰¹æ®Šæ™‚æ®µ</div>
                </div>
            </div>

            <div id="timeFields">
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" id="startGroup" style="flex: 1;">
                        <label for="startTime">é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="startTime">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="endTime">çµæŸæ™‚é–“</label>
                        <input type="time" id="endTime" required>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>åŠ ç­äº‹ç”±</label>
                <select id="reasonSelect" onchange="if(this.value) document.getElementById('reason').value=this.value" style="margin-bottom: 8px;">
                </select>
                <textarea id="reason" rows="3" placeholder="è«‹æ‰‹å‹•è¼¸å…¥æˆ–å¾ä¸Šæ–¹å¿«é€Ÿé¸æ“‡..." required></textarea>
                
                <button type="button" class="btn btn-ocr" onclick="document.getElementById('ocrInput').click()">ğŸ“· OCR æ™ºæ…§è¾¨è­˜</button>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary">é€å‡ºç™»è¨˜</button>
            <input type="file" id="ocrInput" accept="image/*" class="hidden" onchange="openCrop(this)">
        </form>

        <div class="bottom-controls">
            <button class="btn btn-secondary" style="width: 100%;" onclick="showConfig()">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>
    </div>

    <div id="configView" class="view hidden">
        <header>
            <h2>ç³»çµ±è¨­å®š</h2>
            <button class="btn btn-secondary" onclick="hideConfig()">è¿”å›</button>
        </header>
        <div id="configMsg" class="msg"></div>

        <div class="form-group">
            <label>æ‚¨çš„å§“å (ç”¨æ–¼è‡ªå‹•å¡«å¯«)</label>
            <input type="text" id="userNameSetting" placeholder="ä¾‹å¦‚ï¼šé‡‘åŸæ­¦">
        </div>
        <div class="form-group">
            <label>GAS ç¶²å€ (æ‚¨çš„ API)</label>
            <input type="text" id="gasUrlInput" placeholder="è«‹è²¼ä¸Š .exec ç¶²å€">
        </div>
        <div class="form-group">
            <label>å¸¸ç”¨äº‹ç”± (è«‹ç”¨é€—è™Ÿ [,] åˆ†éš”)</label>
            <textarea id="customReasonsConfig" rows="3"></textarea>
        </div>

        <button class="btn btn-primary" onclick="saveConfig()">å„²å­˜ä¸¦è¿”å›</button>
    </div>
</div>

<div id="cropModal" class="hidden">
    <div style="flex:1; background:#000; display: flex; align-items: center; justify-content: center; overflow:hidden;">
        <img id="imageToCrop" style="max-width:100%; max-height:100%;">
    </div>
    <div class="crop-footer">
        <button class="btn btn-secondary" onclick="closeCrop()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="doOCR()"><span id="ocrStatus">ç¢ºèªä¸¦è¾¨è­˜</span></button>
    </div>
</div>

<script>
    const els = {
        main: document.getElementById('mainView'), config: document.getElementById('configView'),
        form: document.getElementById('otForm'), msg: document.getElementById('msg'),
        configMsg: document.getElementById('configMsg'),
        submitBtn: document.getElementById('submitBtn'),
        startGroup: document.getElementById('startGroup'), cropModal: document.getElementById('cropModal'),
        imageToCrop: document.getElementById('imageToCrop'), ocrStatus: document.getElementById('ocrStatus'),
        gasInput: document.getElementById('gasUrlInput'), userNameSetting: document.getElementById('userNameSetting'),
        customReasonsConfig: document.getElementById('customReasonsConfig'), reasonSelect: document.getElementById('reasonSelect'),
        reasonText: document.getElementById('reason'), fsSlider: document.getElementById('fontSizeSlider'), fsVal: document.getElementById('fontSizeVal')
    };

    let cropper = null;

    window.onload = () => {
        const url = localStorage.getItem('gas_url');
        const fontSize = localStorage.getItem('base_font_size') || '16';
        const savedName = localStorage.getItem('user_name') || '';
        const savedReasons = localStorage.getItem('custom_reasons') || "äº¤æ¥è¼ªå€¼,ç™¾è²¨é¡è™•ç†,æ•™ç§‘æ›¸è™•ç†,æ•¸ä½å°åˆ·,è‡¨æ™‚æ€¥ä»¶";
        
        // è¼‰å…¥ä¸»é¡Œè¨­å®š
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        updateFontSize(fontSize);
        els.fsSlider.value = fontSize;
        els.gasInput.value = url || '';
        els.userNameSetting.value = savedName;
        els.customReasonsConfig.value = savedReasons;

        renderReasonOptions(savedReasons);

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        document.getElementById('date').value = `${year}-${month}-${day}`;
        document.getElementById('endTime').value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        if (!url) showConfig();
        setMode('regular');
    };

    window.updateFontSize = (val) => {
        document.documentElement.style.setProperty('--base-font-size', val + 'px');
        els.fsVal.textContent = val + 'px';
        localStorage.setItem('base_font_size', val);
    };

    window.renderReasonOptions = (reasonsStr) => {
        els.reasonSelect.innerHTML = '<option value="" selected disabled>-- å¿«é€Ÿé¸æ“‡ --</option>';
        reasonsStr.split(/[,ï¼Œ\n]+/).map(s => s.trim()).filter(s => s).forEach(item => {
            const opt = document.createElement('option'); opt.value = opt.textContent = item;
            els.reasonSelect.appendChild(opt);
        });
    };

    window.setMode = (mode) => {
        document.querySelectorAll('#subModeTabs .mode-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`mode-${mode}`).classList.add('active');
        
        const offTime = localStorage.getItem('std_off') || '17:30';
        const startTime = localStorage.getItem('std_start') || '08:30';
        
        if (mode === 'regular') {
            els.startGroup.classList.add('hidden');
            document.getElementById('startTime').value = offTime;
        } else {
            els.startGroup.classList.remove('hidden');
            document.getElementById('startTime').value = (mode === 'overtime') ? offTime : startTime;
        }
    };

    window.showConfig = () => { els.main.classList.add('hidden'); els.config.classList.remove('hidden'); };
    window.hideConfig = () => { els.config.classList.add('hidden'); els.main.classList.remove('hidden'); };

    window.setTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        
        document.getElementById('theme-light').classList.toggle('active', theme === 'light');
        document.getElementById('theme-dark').classList.toggle('active', theme === 'dark');
    };

    window.saveConfig = () => {
        const url = els.gasInput.value.trim();
        if(!url) return showMsg('ç¶²å€ä¸å¯ç‚ºç©º', 'error', 'config');
        localStorage.setItem('gas_url', url);
        localStorage.setItem('user_name', els.userNameSetting.value.trim());
        localStorage.setItem('custom_reasons', els.customReasonsConfig.value);
        renderReasonOptions(els.customReasonsConfig.value);
        showMsg('è¨­å®šå·²å„²å­˜', 'success', 'config');
        setTimeout(hideConfig, 600);
    };

    window.handleSubmit = (e) => {
        e.preventDefault();
        const url = localStorage.getItem('gas_url');
        const userName = localStorage.getItem('user_name') || 'User';
        if(!url) return alert('è«‹å…ˆè¨­å®š API ç¶²å€');

        els.submitBtn.disabled = true; els.submitBtn.textContent = 'å‚³é€ä¸­...';
        showMsg('å‚³é€ä¸­...', '');
        
        const formData = new FormData();
        formData.append('action', 'submit'); 
        formData.append('date', document.getElementById('date').value);
        formData.append('name', userName);
        
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆ¤æ–·æ¨¡å¼æ±ºå®šæ˜¯å¦å‚³é€ StartTime ---
        const isRegular = document.getElementById('mode-regular').classList.contains('active');
        if (!isRegular) {
            // éå¸¸è¦æ¨¡å¼ (ç‰¹å®šåŠ ç­/ç‰¹æ®Šæ™‚æ®µ)ï¼šå‚³é€ä»‹é¢ä¸Šçš„é–‹å§‹æ™‚é–“
            formData.append('startTime', document.getElementById('startTime').value);
        } else {
            // å¸¸è¦æ¨¡å¼ï¼šèµ·å§‹ä¸ç”¨ (å‚³é€ç©ºå­—ä¸²ï¼Œç¢ºä¿å¾Œç«¯æ¬„ä½å°é½Šä½†ç„¡å…§å®¹)
            formData.append('startTime', '');
        }

        formData.append('endTime', document.getElementById('endTime').value);
        formData.append('reason', els.reasonText.value);

        fetch(url, { method: 'POST', body: formData })
            .then(r => r.json()).then(d => {
                if(d.result === 'success' || d.status === 'success') {
                    showMsg('âœ… ç™»è¨˜æˆåŠŸï¼', 'success');
                    els.reasonText.value = ''; els.reasonSelect.value = '';
                } else { 
                    showMsg('âŒ éŒ¯èª¤: ' + (d.error || d.message), 'error'); 
                }
            })
            .catch(() => showMsg('âŒ ç¶²è·¯é€šè¨Šå¤±æ•—', 'error'))
            .finally(() => { 
                els.submitBtn.disabled = false; 
                els.submitBtn.textContent = 'é€å‡ºç™»è¨˜'; 
            });
    };

    function showMsg(txt, type, target = 'main') {
        const el = target === 'config' ? els.configMsg : els.msg;
        el.textContent = txt; el.className = 'msg ' + type; el.style.display = 'block';
        if(type === 'success') setTimeout(() => el.style.display = 'none', 3000);
    }

    window.openCrop = (input) => {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            els.imageToCrop.src = e.target.result; els.cropModal.classList.remove('hidden');
            if(cropper) cropper.destroy();
            cropper = new Cropper(els.imageToCrop, { viewMode: 1, autoCropArea: 0.8 });
        };
        reader.readAsDataURL(input.files[0]);
    };

    window.closeCrop = () => { els.cropModal.classList.add('hidden'); if(cropper) cropper.destroy(); };

    window.doOCR = () => {
        if(!cropper) return;
        const url = localStorage.getItem('gas_url');
        if(!url) return alert('è«‹å…ˆè¨­å®š API ç¶²å€');
        
        els.ocrStatus.textContent = 'è¾¨è­˜ä¸­...';
        const base64 = cropper.getCroppedCanvas({maxWidth: 800}).toDataURL('image/jpeg', 0.7).split(',')[1];
        
        const formData = new FormData(); 
        formData.append('action', 'ocr'); 
        formData.append('image', base64);
        
        fetch(url, { method: 'POST', body: formData })
            .then(r => r.json()).then(d => {
                const resText = d.text || (d.data ? d.data.text : "");
                if((d.result === 'success' || d.status === 'success') && resText) {
                    els.reasonText.value = resText;
                    showMsg('âœ¨ è¾¨è­˜å®Œæˆ', 'success');
                } else { 
                    showMsg('âŒ è¾¨è­˜å¤±æ•—', 'error'); 
                }
            }).catch(() => showMsg('âŒ é€šè¨Šå¤±æ•—', 'error'))
            .finally(() => { els.ocrStatus.textContent = 'ç¢ºèªä¸¦è¾¨è­˜'; closeCrop(); });
    };
</script>
</body>
</html>
