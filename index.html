<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: sans-serif; padding: 20px; text-align: center; }
      #preview { max-width: 100%; max-height: 300px; margin: 10px 0; display: none; border: 1px solid #ccc; }
      button { padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
      button:disabled { background: #ccc; }
      #result { margin-top: 20px; white-space: pre-wrap; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px; }
      .loading { color: #666; font-style: italic; }
    </style>
  </head>
  <body>
    <h3>ğŸ“¸ åŠ ç­äº‹ç”±æ‹ç…§è¾¨è­˜</h3>
    
    <input type="file" id="fileInput" accept="image/*" capture="environment" style="margin-bottom: 10px;">
    <br>
    <img id="preview" />
    <br>
    <button id="uploadBtn" onclick="handleUpload()" disabled>é–‹å§‹è¾¨è­˜</button>
    
    <div id="result"></div>

    <script>
      let compressedBase64 = "";
      let fileType = "";

      // ç›£è½æª”æ¡ˆé¸æ“‡ï¼Œé€²è¡Œé è¦½èˆ‡å£“ç¸®
      document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        fileType = file.type;
        const reader = new FileReader();
        
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            // --- é—œéµï¼šå‰ç«¯å£“ç¸®é‚è¼¯ ---
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­å®šæœ€å¤§å¯¬åº¦ (ä¾‹å¦‚ 1024pxï¼Œå° OCR ä¾†èªªå¾ˆå¤ äº†)
            const maxWidth = 1024;
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // è½‰æˆ Base64 (å“è³ª 0.7)
            const dataUrl = canvas.toDataURL(fileType, 0.7);
            
            // é¡¯ç¤ºé è¦½
            const preview = document.getElementById('preview');
            preview.src = dataUrl;
            preview.style.display = 'inline-block';
            
            // å„²å­˜å£“ç¸®å¾Œçš„è³‡æ–™ (å»æ‰ data:image/xxx;base64, å‰ç¶´)
            compressedBase64 = dataUrl.split(',')[1];
            
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('result').innerText = "âœ… åœ–ç‰‡å·²å£“ç¸®æº–å‚™å°±ç·’ (" + Math.round(compressedBase64.length/1024) + " KB)";
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      function handleUpload() {
        const btn = document.getElementById('uploadBtn');
        const resultDiv = document.getElementById('result');
        
        btn.disabled = true;
        btn.innerText = "è¾¨è­˜ä¸­...";
        resultDiv.innerText = "ğŸš€ æ­£åœ¨å‚³é€ä¸¦è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™...";

        // å‘¼å«å¾Œç«¯ Google Apps Script
        google.script.run
          .withSuccessHandler(function(response) {
            btn.disabled = false;
            btn.innerText = "é–‹å§‹è¾¨è­˜";
            if (response.success) {
              resultDiv.innerText = response.text;
            } else {
              resultDiv.innerText = "âŒ å¤±æ•—ï¼š" + response.text;
            }
          })
          .withFailureHandler(function(error) {
            btn.disabled = false;
            btn.innerText = "é–‹å§‹è¾¨è­˜";
            resultDiv.innerText = "âŒ ç³»çµ±éŒ¯èª¤ï¼š" + error.message;
          })
          .processImage(compressedBase64, fileType);
      }
    </script>
  </body>
</html>
