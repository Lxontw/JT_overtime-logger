<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§åŠ ç­ç™»è¨˜ç³»çµ±</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* æ”¹ç‚ºä¸Šæ–¹å°é½Šï¼Œé¿å…å…§å®¹å¤šæ™‚è¢«åˆ‡æ‰ */
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
        }
        .container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 420px;
            position: relative;
        }
        h2 { text-align: center; color: #333; margin: 0 0 1.5rem 0; font-size: 1.5rem;}
        
        /* è¡¨å–®å…ƒä»¶å„ªåŒ– */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.4rem; color: #555; font-weight: 600; font-size: 0.9rem;}
        input, textarea, select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; background: #fff;
            appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
        }
        input:focus, textarea:focus, select:focus { border-color: #007bff; outline: none; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-primary {
            width: 100%; padding: 14px; background-color: #007bff; color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: background 0.2s; margin-top: 10px;
        }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* OCR æŒ‰éˆ• */
        .ocr-btn {
            background-color: #6f42c1; color: white; border: none; 
            padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;
            margin-left: auto; display: inline-block;
        }
        .label-row { display: flex; justify-content: space-between; align-items: center; }

        /* åˆ†é ç±¤ (Tabs) */
        .tabs { display: flex; margin-bottom: 1rem; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .tab {
            flex: 1; text-align: center; padding: 10px; cursor: pointer;
            border-radius: 6px; color: #666; font-weight: 500; transition: 0.3s;
        }
        .tab.active { background: white; color: #007bff; shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* è¨­å®šæŒ‰éˆ• */
        .settings-btn {
            position: absolute; top: 15px; right: 15px;
            background: none; border: none; color: #aaa; cursor: pointer; font-size: 20px; padding: 5px;
        }

        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none; }
        
        /* è¨Šæ¯æ¡† */
        .msg { text-align: center; margin-top: 1rem; font-size: 14px; padding: 10px; border-radius: 6px;}
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .loading-ocr { color: #6f42c1; font-size: 12px; margin-top: 5px;}

        /* OCR é è¦½åœ– */
        #ocrPreview { max-width: 100%; margin-top: 10px; border-radius: 6px; display: none;}
    </style>
</head>
<body>

<div class="container">
    <button class="settings-btn" onclick="showPanel('setupPanel')">âš™ï¸</button>

    <div id="setupPanel" class="hidden">
        <h2>ğŸ› ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="form-group">
            <label>GAS ç¶²å€ (API URL)</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/..." style="font-size: 12px;">
        </div>
        <div class="form-group">
            <label>æ¨™æº–ä¸‹ç­æ™‚é–“ (å¸¸è¦æ¨¡å¼èµ·å§‹æ™‚é–“)</label>
            <input type="time" id="stdOffTime" value="17:30">
        </div>
        <div class="form-group">
            <label>å¸¸ç”¨åŠ ç­äº‹ç”± (ç”¨é€—è™Ÿåˆ†éš”)</label>
            <textarea id="commonReasons" rows="3">å°ˆæ¡ˆè¶•å·¥,éƒ¨é–€æœƒè­°,å®¢æˆ¶éœ€æ±‚è™•ç†,ç·Šæ€¥ç¶­ä¿®</textarea>
        </div>
        <button class="btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        <button class="btn-primary" style="background:#6c757d; margin-top:10px;" onclick="showPanel('mainPanel')">è¿”å›</button>
    </div>

    <div id="mainPanel">
        <h2>â° åŠ ç­ç™»è¨˜</h2>
        
        <div class="tabs">
            <div class="tab active" onclick="switchMode('quick')">ğŸš€ å¿«é€Ÿæ‰“å¡</div>
            <div class="tab" onclick="switchMode('custom')">ğŸ› ï¸ è‡ªè¨‚æ™‚æ®µ</div>
        </div>

        <form id="overtimeForm">
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="name" name="name" required>
            </div>

            <div class="form-group">
                <label>æ—¥æœŸ</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div id="quickTimeGroup">
                <div class="form-group">
                    <label>åŠ ç­è‡³ (å¾ <span id="displayStdTime">17:30</span> é–‹å§‹)</label>
                    <input type="time" id="quickEndTime" onchange="syncTime()">
                </div>
            </div>

            <div id="customTimeGroup" class="hidden">
                <div class="form-group">
                    <label>å®Œæ•´æ™‚æ®µ</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="time" id="startTime" name="startTime">
                        <span style="align-self: center;">~</span>
                        <input type="time" id="endTime" name="endTime">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <div class="label-row">
                    <label>åŠ ç­äº‹ç”±</label>
                    <div style="position: relative;">
                        <input type="file" id="ocrInput" accept="image/*" style="display: none;" onchange="handleOCR(this)">
                        <button type="button" class="ocr-btn" onclick="document.getElementById('ocrInput').click()">ğŸ“· æ‹ç…§è¾¨è­˜</button>
                    </div>
                </div>
                
                <select id="reasonSelect" onchange="handleReasonSelect()" style="margin-bottom: 8px;">
                    <option value="" disabled selected>-- é¸æ“‡å¸¸ç”¨äº‹ç”± --</option>
                    </select>
                
                <textarea id="reason" name="reason" rows="2" placeholder="è©³ç´°èªªæ˜..." required></textarea>
                <div id="ocrStatus" class="loading-ocr"></div>
                <img id="ocrPreview">
            </div>

            <button type="submit" id="submitBtn" class="btn-primary">é€å‡ºç™»è¨˜</button>
            <div id="message" class="msg" style="display:none;"></div>
        </form>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
    const CONFIG = {
        gasUrl: '',
        stdTime: '17:30',
        reasons: ['å°ˆæ¡ˆè¶•å·¥', 'éƒ¨é–€æœƒè­°']
    };

    // DOM å…ƒç´ è¼‰å…¥
    const els = {
        setup: document.getElementById('setupPanel'),
        main: document.getElementById('mainPanel'),
        apiUrl: document.getElementById('apiUrl'),
        stdOffTime: document.getElementById('stdOffTime'),
        commonReasons: document.getElementById('commonReasons'),
        form: document.getElementById('overtimeForm'),
        name: document.getElementById('name'),
        date: document.getElementById('date'),
        quickGroup: document.getElementById('quickTimeGroup'),
        customGroup: document.getElementById('customTimeGroup'),
        quickEndTime: document.getElementById('quickEndTime'),
        startTime: document.getElementById('startTime'),
        endTime: document.getElementById('endTime'),
        reasonSelect: document.getElementById('reasonSelect'),
        reason: document.getElementById('reason'),
        msg: document.getElementById('message'),
        submitBtn: document.getElementById('submitBtn'),
        displayStdTime: document.getElementById('displayStdTime'),
        ocrStatus: document.getElementById('ocrStatus'),
        ocrPreview: document.getElementById('ocrPreview')
    };

    // å•Ÿå‹•æ™‚åŸ·è¡Œ
    init();

    function init() {
        loadConfig();
        // è¨­å®šä»Šå¤©æ—¥æœŸ
        els.date.valueAsDate = new Date();
        // è¼‰å…¥ä¸Šæ¬¡å§“å
        els.name.value = localStorage.getItem('ot_username') || '';
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆå§‹è¨­å®š
        if (!CONFIG.gasUrl) {
            showPanel('setupPanel');
        } else {
            showPanel('mainPanel');
        }
        
        updateReasonOptions();
    }

    // --- è¨­å®šç›¸é—œé‚è¼¯ ---
    function loadConfig() {
        CONFIG.gasUrl = localStorage.getItem('user_gas_url') || '';
        CONFIG.stdTime = localStorage.getItem('user_std_time') || '17:30';
        const savedReasons = localStorage.getItem('user_reasons');
        if (savedReasons) {
            CONFIG.reasons = savedReasons.split(',');
        }

        // å¡«å…¥è¨­å®šç•«é¢çš„æ¬„ä½
        els.apiUrl.value = CONFIG.gasUrl;
        els.stdOffTime.value = CONFIG.stdTime;
        els.commonReasons.value = CONFIG.reasons.join(',');
        els.displayStdTime.textContent = CONFIG.stdTime;
    }

    function saveSettings() {
        const url = els.apiUrl.value.trim();
        if (!url.startsWith('https://script.google.com/')) {
            alert('ç¶²å€æ ¼å¼éŒ¯èª¤ï¼éœ€ç‚º https://script.google.com/ é–‹é ­');
            return;
        }
        
        localStorage.setItem('user_gas_url', url);
        localStorage.setItem('user_std_time', els.stdOffTime.value);
        // è™•ç†å…¨å½¢é€—è™Ÿ
        const reasonsStr = els.commonReasons.value.replace(/ï¼Œ/g, ',');
        localStorage.setItem('user_reasons', reasonsStr);

        loadConfig(); // é‡æ–°è¼‰å…¥è¨˜æ†¶é«”
        updateReasonOptions(); // æ›´æ–°é¸å–®
        alert('è¨­å®šå·²å„²å­˜ï¼');
        showPanel('mainPanel');
    }

    function showPanel(panelId) {
        els.setup.classList.add('hidden');
        els.main.classList.add('hidden');
        document.getElementById(panelId).classList.remove('hidden');
    }

    // --- æ¨¡å¼åˆ‡æ›èˆ‡æ™‚é–“åŒæ­¥ ---
    function switchMode(mode) {
        // æ›´æ–° Tab æ¨£å¼
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');

        if (mode === 'quick') {
            els.quickGroup.classList.remove('hidden');
            els.customGroup.classList.add('hidden');
            // å¿«é€Ÿæ¨¡å¼ä¸‹ï¼Œèµ·å§‹æ™‚é–“å¼·åˆ¶è¨­ç‚ºæ¨™æº–æ™‚é–“
            els.startTime.value = CONFIG.stdTime;
            // å¿…å¡«å±¬æ€§åˆ‡æ› (é¿å…ç€è¦½å™¨é©—è­‰éš±è—æ¬„ä½)
            els.quickEndTime.required = true;
            els.startTime.required = false;
            els.endTime.required = false;
        } else {
            els.quickGroup.classList.add('hidden');
            els.customGroup.classList.remove('hidden');
            // åˆ‡æ›åˆ°è‡ªè¨‚æ¨¡å¼ï¼Œå¯èƒ½éœ€è¦æ¸…ç©ºæˆ–ä¿ç•™
            els.quickEndTime.required = false;
            els.startTime.required = true;
            els.endTime.required = true;
        }
    }

    // ç•¶å¿«é€Ÿæ¨¡å¼çš„æ™‚é–“æ”¹è®Šæ™‚ï¼ŒåŒæ­¥å¯«å…¥éš±è—çš„æ­£å¼æ¬„ä½
    function syncTime() {
        // åœ¨ submit å‰æˆ‘å€‘ä¸»è¦ä¾è³´ startTime å’Œ endTime æ¬„ä½çš„å€¼
        // æ‰€ä»¥å¿«é€Ÿæ¨¡å¼ä¸‹ï¼Œè¦æŠŠå€¼å¡é€² endTime
        els.endTime.value = els.quickEndTime.value;
    }

    // --- äº‹ç”±é¸å–®é‚è¼¯ ---
    function updateReasonOptions() {
        els.reasonSelect.innerHTML = '<option value="" disabled selected>-- é¸æ“‡å¸¸ç”¨äº‹ç”± --</option>';
        CONFIG.reasons.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r;
            opt.textContent = r;
            els.reasonSelect.appendChild(opt);
        });
        // åŠ å…¥ä¸€å€‹æ¸…é™¤/æ‰‹å‹•é¸é …
        const clearOpt = document.createElement('option');
        clearOpt.value = "";
        clearOpt.textContent = "âœï¸ æ‰‹å‹•è¼¸å…¥ / æ¸…é™¤";
        els.reasonSelect.appendChild(clearOpt);
    }

    function handleReasonSelect() {
        const val = els.reasonSelect.value;
        if (val) {
            els.reason.value = val;
        } else {
            els.reason.value = "";
            els.reason.focus();
        }
    }

    // --- OCR (æ‹ç…§è¾¨è­˜) é‚è¼¯ ---
    function handleOCR(input) {
        const file = input.files[0];
        if (!file) return;

        els.ocrStatus.textContent = "â³ æ­£åœ¨è®€å–ä¸¦åˆ†æåœ–ç‰‡æ–‡å­—ï¼Œè«‹ç¨å€™ (åˆæ¬¡éœ€ä¸‹è¼‰èªè¨€åŒ…)...";
        els.ocrStatus.style.display = "block";
        
        // é¡¯ç¤ºé è¦½
        const reader = new FileReader();
        reader.onload = function(e) {
            els.ocrPreview.src = e.target.result;
            els.ocrPreview.style.display = "block";
        }
        reader.readAsDataURL(file);

        // ä½¿ç”¨ Tesseract.js é€²è¡Œè¾¨è­˜ (ç¹é«”ä¸­æ–‡ chi_tra)
        Tesseract.recognize(
            file,
            'chi_tra', 
            { 
                logger: m => {
                    if(m.status === 'recognizing text') {
                        els.ocrStatus.textContent = `â³ è¾¨è­˜ä¸­... ${(m.progress * 100).toFixed(0)}%`;
                    }
                }
            }
        ).then(({ data: { text } }) => {
            // è™•ç†è¾¨è­˜çµæœï¼šå»é™¤éå¤šç©ºç™½
            const cleanText = text.replace(/\s+/g, ' ').trim();
            
            // é™„åŠ åˆ°ç¾æœ‰å…§å®¹å¾Œæ–¹
            const currentVal = els.reason.value;
            els.reason.value = currentVal ? currentVal + " " + cleanText : cleanText;
            
            els.ocrStatus.textContent = "âœ… è¾¨è­˜å®Œæˆï¼";
            setTimeout(() => { 
                els.ocrStatus.style.display = 'none'; 
                els.ocrPreview.style.display = 'none';
            }, 3000);
        }).catch(err => {
            console.error(err);
            els.ocrStatus.textContent = "âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦æˆ–æ‰‹å‹•è¼¸å…¥ã€‚";
        });
    }

    // --- è¡¨å–®é€å‡º ---
    els.form.addEventListener('submit', e => {
        e.preventDefault();
        
        // ç¢ºä¿æ™‚é–“å€¼æ­£ç¢º (è‹¥æ˜¯å¿«é€Ÿæ¨¡å¼ï¼Œå†æ¬¡ç¢ºä¿ startTime æ­£ç¢º)
        if (!els.customGroup.classList.contains('hidden')) {
            // è‡ªè¨‚æ¨¡å¼ï¼šå€¼å·²ç¶“åœ¨ input è£¡
        } else {
            // å¿«é€Ÿæ¨¡å¼ï¼šåŒæ­¥å€¼
            els.startTime.value = CONFIG.stdTime;
            els.endTime.value = els.quickEndTime.value;
        }

        if (!els.startTime.value || !els.endTime.value) {
            alert('è«‹å¡«å¯«å®Œæ•´çš„æ™‚é–“ï¼');
            return;
        }

        els.submitBtn.disabled = true;
        els.submitBtn.textContent = 'è³‡æ–™å‚³é€ä¸­...';
        els.msg.style.display = 'none';

        // è¨˜æ†¶å§“å
        localStorage.setItem('ot_username', els.name.value);

        const formData = new FormData(els.form);
        
        fetch(CONFIG.gasUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.result === 'success') {
                els.msg.textContent = 'âœ… ç™»è¨˜æˆåŠŸï¼';
                els.msg.className = 'msg success';
                els.msg.style.display = 'block';
                // æ¸…ç©ºéä¿ç•™æ¬„ä½
                els.reason.value = '';
                els.reasonSelect.value = '';
                els.quickEndTime.value = '';
                els.endTime.value = '';
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            els.msg.textContent = 'âŒ éŒ¯èª¤ï¼š' + error.message;
            els.msg.className = 'msg error';
            els.msg.style.display = 'block';
        })
        .finally(() => {
            els.submitBtn.disabled = false;
            els.submitBtn.textContent = 'é€å‡ºç™»è¨˜';
        });
    });
</script>

</body>
</html>
