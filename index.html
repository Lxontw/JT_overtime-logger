<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŠ ç­è¨˜éŒ„å™¨</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        /* --- æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --text-color: #333333;
            --label-color: #555555;
            --border-color: #dddddd;
            --input-bg: #ffffff;
            --shadow-color: rgba(0,0,0,0.08);
            --tab-bg: #e9ecef;
            --tab-active-bg: #ffffff;
            --tab-active-color: #007bff;
            --primary-btn-bg: linear-gradient(135deg, #007bff, #0056b3);
            --secondary-btn-bg: #6c757d;
            --ocr-btn-bg: #6f42c1;
            --msg-success-bg: #d4edda; --msg-success-text: #155724;
            --msg-error-bg: #f8d7da; --msg-error-text: #721c24;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --label-color: #aaaaaa;
            --border-color: #333333;
            --input-bg: #2d2d2d;
            --shadow-color: rgba(0,0,0,0.3);
            --tab-bg: #2d2d2d;
            --tab-active-bg: #3a3a3a;
            --tab-active-color: #58a6ff;
            --primary-btn-bg: linear-gradient(135deg, #0a84ff, #0060df);
            --secondary-btn-bg: #4a4a4a;
            --ocr-btn-bg: #8a63d2;
            --msg-success-bg: #053315; --msg-success-text: #75b798;
            --msg-error-bg: #491217; --msg-error-text: #e99da5;
        }

        /* --- å­—é«”æ”¾å¤§è¨­å®š --- */
        body.font-large { font-size: 1.15rem; }
        body.font-extra-large { font-size: 1.3rem; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-color); color: var(--text-color);
            padding: 20px 10px; display: flex; justify-content: center; 
            transition: all 0.3s; font-size: 1rem;
        }
        .container { 
            background: var(--container-bg); padding: 1.5rem; border-radius: 16px; 
            box-shadow: 0 4px 20px var(--shadow-color); 
            width: 100%; max-width: 420px; position: relative;
        }

        /* --- æ¨™é¡Œç½®ä¸­ --- */
        header { margin-bottom: 1.5rem; text-align: center; }
        h2 { margin: 0; font-weight: 700; }

        /* --- 1. åŠŸèƒ½åœ–ç¤ºç§»è‡³æŒ‰éˆ•ä¸Šæ–¹ --- */
        .bottom-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 2rem; /* æ‹‰é–‹ä¸Šæ–¹å‚ç›´é–“è· */
            margin-bottom: 0.8rem;
        }
        
        .control-icon {
            cursor: pointer; background: var(--tab-bg);
            width: 40px; height: 40px; display: flex; justify-content: center; align-items: center;
            border-radius: 50%; transition: transform 0.2s;
            font-size: 1.2rem;
        }
        /* iOS é¢¨æ ¼ AA åœ–ç¤ºæ–‡å­— */
        .font-icon { font-weight: bold; font-family: "Times New Roman", serif; font-size: 1rem; }

        .form-group { margin-bottom: 1.25rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--label-color); }
        
        input, select, textarea { 
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); 
            background: var(--input-bg); color: var(--text-color);
            border-radius: 10px; font-size: 1rem; box-sizing: border-box; 
        }

        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .ocr-btn { background: var(--ocr-btn-bg); padding: 6px 12px; border: none; font-size: 0.85em; border-radius: 6px; color: white; cursor: pointer; }

        .btn { 
            width: 100%; padding: 1rem; border: none; border-radius: 10px; 
            font-size: 1.1em; font-weight: bold; cursor: pointer; color: white;
        }
        .btn-primary { background: var(--primary-btn-bg); }
        .btn-secondary { background: var(--secondary-btn-bg); }

        .mode-tabs { display: flex; gap: 6px; margin-bottom: 1.25rem; background: var(--tab-bg); padding: 4px; border-radius: 10px; }
        .mode-tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 8px; font-size: 0.9em; color: var(--label-color); }
        .mode-tab.active { background: var(--tab-active-bg); color: var(--tab-active-color); font-weight: bold; box-shadow: 0 2px 4px var(--shadow-color); }

        .hidden { display: none !important; }
        #cropModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 999; display: flex; flex-direction: column; }
        .crop-area { flex: 1; overflow: hidden; position: relative; }
        .crop-actions { padding: 15px; background: var(--container-bg); display: flex; gap: 10px; }
        .msg { padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; display: none; }
    </style>
</head>
<body>

<div id="cropModal" class="hidden">
    <div class="crop-area"><img id="imageToCrop" style="max-width: 100%;"></div>
    <div class="crop-actions">
        <button class="btn btn-secondary" onclick="closeCrop()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="doOCR()">ç¢ºèªä¸¦è¾¨è­˜</button>
    </div>
</div>

<div class="container">
    <header>
        <h2>åŠ ç­è¨˜éŒ„å™¨</h2>
    </header>
    
    <div id="setupPanel" class="hidden">
        <div class="form-group">
            <label>æ‚¨çš„å§“å (ç”¨æ–¼è‡ªå‹•å¡«å¯«)</label>
            <input type="text" id="userNameSetting" placeholder="ä¾‹å¦‚ï¼šé‡‘åŸæ­¦">
        </div>
        <div class="form-group">
            <label>GAS ç¶²å€ (æ‚¨çš„ API)</label>
            <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/xxx/exec">
        </div>
        <div class="form-group">
            <label>å¸¸ç”¨äº‹ç”± (è«‹ç”¨é€—è™Ÿ [,] åˆ†éš”)</label>
            <textarea id="customReasonsConfig" rows="3" placeholder="ä¾‹å¦‚ï¼šåŠ ç­äº‹ç”±1..."></textarea>
        </div>

        <div class="bottom-controls">
            <div class="control-icon" onclick="toggleFontSize()"><span class="font-icon">AA</span></div>
            <div class="control-icon" onclick="toggleTheme()">ğŸŒ“</div>
        </div>
        <button class="btn btn-primary" onclick="saveConfig()">å„²å­˜ä¸¦è¿”å›</button>
    </div>

    <div id="mainPanel">
        <div class="form-group">
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" required>
        </div>

        <div class="mode-tabs">
            <div class="mode-tab active" onclick="setMode('regular')">å¸¸è¦ä¸‹ç­</div>
            <div class="mode-tab" onclick="setMode('overtime')">ç‰¹å®šåŠ ç­</div>
            <div class="mode-tab" onclick="setMode('special')">ç‰¹æ®Šæ™‚æ®µ</div>
        </div>

        <form id="otForm">
            <input type="hidden" id="name" name="name">
            <div class="form-group" id="startTimeGroup" class="hidden">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="time" id="startTime">
            </div>
            <div class="form-group">
                <label>çµæŸæ™‚é–“</label>
                <input type="time" id="endTime" required>
            </div>

            <div class="form-group">
                <div class="label-row">
                    <label style="margin:0;">åŠ ç­äº‹ç”±</label>
                    <button type="button" class="ocr-btn" onclick="document.getElementById('fileIn').click()">ğŸ“· OCR è¾¨è­˜</button>
                </div>
                <input type="file" id="fileIn" accept="image/*" hidden onchange="openCrop(this)">
                <select id="reasonSelect" onchange="this.value ? document.getElementById('reason').value=this.value : null" style="margin-bottom:8px;">
                    <option value="" selected disabled>-- å¿«é€Ÿé¸æ“‡ --</option>
                </select>
                <textarea id="reason" rows="3" placeholder="è¼¸å…¥äº‹ç”±..." required></textarea>
                <div id="ocrStatus" style="font-size:0.85em; color:var(--ocr-btn-bg); margin-top:5px; font-weight: 500;"></div>
            </div>

            <div class="bottom-controls">
                <div class="control-icon" onclick="toggleFontSize()"><span class="font-icon">AA</span></div>
                <div class="control-icon" onclick="toggleTheme()">ğŸŒ“</div>
                <div class="control-icon" onclick="toggleSettings()">âš™ï¸</div>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary">é€å‡ºç™»è¨˜</button>
        </form>
        <div id="msgBox" class="msg"></div>
    </div>
</div>

<script>
    const els = {
        setup: document.getElementById('setupPanel'), main: document.getElementById('mainPanel'),
        apiUrl: document.getElementById('apiUrl'),
        userNameSetting: document.getElementById('userNameSetting'),
        customReasonsConfig: document.getElementById('customReasonsConfig'),
        reasonSelect: document.getElementById('reasonSelect'),
        date: document.getElementById('date'), startTime: document.getElementById('startTime'), endTime: document.getElementById('endTime'),
        startGroup: document.getElementById('startTimeGroup'), reason: document.getElementById('reason'),
        submitBtn: document.getElementById('submitBtn'), msg: document.getElementById('msgBox'),
        imageToCrop: document.getElementById('imageToCrop'), cropModal: document.getElementById('cropModal'),
        ocrStatus: document.getElementById('ocrStatus')
    };
    
    let cropper = null;

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    const fontSizes = ['', 'font-large', 'font-extra-large'];
    let currentFontIndex = parseInt(localStorage.getItem('fontSizeIdx') || 0);

    function toggleFontSize() {
        if (fontSizes[currentFontIndex]) document.body.classList.remove(fontSizes[currentFontIndex]);
        currentFontIndex = (currentFontIndex + 1) % fontSizes.length;
        if (fontSizes[currentFontIndex]) document.body.classList.add(fontSizes[currentFontIndex]);
        localStorage.setItem('fontSizeIdx', currentFontIndex);
    }

    window.onload = () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        if (fontSizes[currentFontIndex]) document.body.classList.add(fontSizes[currentFontIndex]);

        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        els.date.value = `${year}-${month}-${day}`;
        els.endTime.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

        loadConfig();
        if(!els.apiUrl.value) toggleSettings();
        setMode('regular');
    };

    function loadConfig() {
        els.apiUrl.value = localStorage.getItem('gas_url') || '';
        els.userNameSetting.value = localStorage.getItem('user_name') || '';
        const savedReasons = localStorage.getItem('custom_reasons') || "äº¤æ¥è¼ªå€¼,ç™¾è²¨é¡è™•ç†,æ•™ç§‘æ›¸è™•ç†,æ•¸ä½å°åˆ·,è‡¨æ™‚æ€¥ä»¶";
        els.customReasonsConfig.value = savedReasons;
        renderReasonOptions(savedReasons);
    }
    
    function renderReasonOptions(reasonsStr) {
        els.reasonSelect.innerHTML = '<option value="" selected disabled>-- å¿«é€Ÿé¸æ“‡ --</option>';
        reasonsStr.split(/[,ï¼Œ\n]+/).map(s => s.trim()).filter(s => s).forEach(item => {
            const opt = document.createElement('option'); opt.value = opt.textContent = item;
            els.reasonSelect.appendChild(opt);
        });
    }

    function saveConfig() {
        localStorage.setItem('gas_url', els.apiUrl.value.trim());
        localStorage.setItem('user_name', els.userNameSetting.value.trim());
        localStorage.setItem('custom_reasons', els.customReasonsConfig.value);
        renderReasonOptions(els.customReasonsConfig.value);
        toggleSettings();
    }

    function toggleSettings() {
        const isMain = els.main.style.display !== 'none';
        els.main.style.display = isMain ? 'none' : 'block';
        els.setup.classList.toggle('hidden', !isMain);
    }

    window.setMode = function(mode) {
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
        if (event && event.target.classList.contains('mode-tab')) event.target.classList.add('active');
        const offTime = localStorage.getItem('std_off') || '17:30';
        const startTime = localStorage.getItem('std_start') || '08:30';
        
        if (mode === 'regular') {
            els.startGroup.classList.add('hidden');
            els.startTime.value = offTime;
        } else {
            els.startGroup.classList.remove('hidden');
            els.startTime.value = (mode === 'overtime') ? offTime : startTime;
        }
    };

    document.getElementById('otForm').onsubmit = (e) => {
        e.preventDefault();
        const url = localStorage.getItem('gas_url');
        if(!url) return alert('è«‹å…ˆè¨­å®š API ç¶²å€');
        showMsg('å‚³é€ä¸­...', '');
        els.submitBtn.disabled = true;
        const formData = new FormData();
        formData.append('action', 'submit');
        formData.append('date', els.date.value);
        formData.append('startTime', els.startTime.value);
        formData.append('endTime', els.endTime.value);
        formData.append('reason', els.reason.value);
        formData.append('name', localStorage.getItem('user_name') || 'User'); 

        fetch(url, { method: 'POST', body: formData })
            .then(r => r.json()).then(d => {
                if(d.result === 'success') {
                    showMsg('âœ… ç™»è¨˜æˆåŠŸï¼', 'success');
                    els.reason.value = ''; els.reasonSelect.value = '';
                } else showMsg('âŒ éŒ¯èª¤ï¼š' + d.error, 'error');
            })
            .catch(() => showMsg('âŒ ç¶²è·¯éŒ¯èª¤', 'error'))
            .finally(() => els.submitBtn.disabled = false);
    };

    function showMsg(txt, type) {
        els.msg.textContent = txt; els.msg.className = 'msg ' + type;
        els.msg.style.display = 'block';
        if(type === 'success') setTimeout(() => els.msg.style.display = 'none', 3000);
    }

    window.openCrop = function(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            els.imageToCrop.src = e.target.result;
            els.cropModal.classList.remove('hidden');
            if(cropper) cropper.destroy();
            cropper = new Cropper(els.imageToCrop, { viewMode: 1 });
        };
        reader.readAsDataURL(input.files[0]);
    };

    window.closeCrop = () => { els.cropModal.classList.add('hidden'); if(cropper) cropper.destroy(); };

    window.doOCR = () => {
        if(!cropper) return;
        els.ocrStatus.textContent = 'è¾¨è­˜ä¸­...';
        const base64 = cropper.getCroppedCanvas({maxWidth: 800}).toDataURL('image/jpeg', 0.7).split(',')[1];
        closeCrop();
        const formData = new FormData(); formData.append('action', 'ocr'); formData.append('image', base64);
        fetch(localStorage.getItem('gas_url'), { method: 'POST', body: formData })
            .then(r => r.json()).then(d => {
                if(d.result === 'success') { els.reason.value = d.text; els.ocrStatus.textContent = 'âœ¨ è¾¨è­˜å®Œæˆ'; }
                else els.ocrStatus.textContent = 'âŒ è¾¨è­˜å¤±æ•—';
            }).catch(() => els.ocrStatus.textContent = 'âŒ éŒ¯èª¤');
    };
</script>
</body>
</html>