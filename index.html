<!-- ç„¡ç›¡ç«åŸŸï¼šç¥é­„ç™»è¨˜ -->
<!-- 2026.02.06 V1.08 å¯¦æ©Ÿæ»¿ç‰ˆå›é­‚ç‰ˆï¼šå¾¹åº•è§£æ±ºæ‰‹æ©Ÿç«¯æ™‚é–“æ¡†ç¸®æ°´èˆ‡ç©ºç™½å•é¡Œ -->
<!DOCTYPE html>
<html lang="zh-TW" data-theme="poryphone">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç„¡ç›¡ç«åŸŸï¼šç¥é­„ç™»è¨˜</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        /* =========================================
           æ ¸å¿ƒä¸»é¡Œè®Šæ•¸ (Game UI Theme)
           ========================================= */
        :root {
            --base-font-size: 16px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --pory-cyan: #2bc0d1;
            --pory-dark: #1a6b7d;
            --pory-accent: #57d5e5;
            --warning-red: #ef4444;
            --grid-gap: 12px; 
        }

        html { font-size: var(--base-font-size); }

        [data-theme="poryphone"] {
            --bg-gradient: linear-gradient(180deg, #57d5e5 0%, #1a8a99 100%);
            --header-text: #ffffff;
            --text-color: #ffffff;
            --label-color: #b2f0f7;
            --input-bg: rgba(255, 255, 255, 0.95);
            --input-text: #1a6b7d;
            --btn-primary: linear-gradient(135deg, #4edeea, #26a9b8);
            --clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);
            --overlay-bg: rgba(26, 138, 153, 0.95);
            --toast-bg: #ffffff;
            --toast-text: #1a6b7d;
            --active-dot-bg: #ffffff;
            --active-dot-text: #1a6b7d;
            --glow-color: rgba(255, 255, 255, 0.8);
            --active-border: 2px solid #ffffff;
            --input-time-bg: rgba(0, 0, 0, 0.25);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            --header-text: #334155;
            --text-color: #334155;
            --label-color: #64748b;
            --input-bg: #ffffff;
            --input-text: #334155;
            --btn-primary: linear-gradient(135deg, #64748b, #334155);
            --clip-path: none;
            --overlay-bg: rgba(248, 250, 252, 0.98);
            --toast-bg: #ffffff;
            --toast-text: #334155;
            --active-dot-bg: #334155;
            --active-dot-text: #ffffff;
            --glow-color: rgba(79, 70, 229, 0.6);
            --active-border: 2px solid #4f46e5;
            --input-time-bg: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(180deg, #111827 0%, #030712 100%);
            --header-text: #ffffff;
            --text-color: #ffffff;
            --label-color: #94a3b8;
            --input-bg: #1f2937;
            --input-text: #ffffff;
            --btn-primary: linear-gradient(135deg, #374151, #111827);
            --clip-path: none;
            --overlay-bg: rgba(17, 24, 39, 0.98);
            --toast-bg: #1f2937;
            --toast-text: #ffffff;
            --active-dot-bg: #ffffff;
            --active-dot-text: #111827;
            --glow-color: #ffffff;
            --active-border: 2px solid #ffffff;
            --input-time-bg: rgba(255, 255, 255, 0.05);
        }

        /* =========================================
           åŸºç¤ä½ˆå±€èˆ‡éæ¸¡
           ========================================= */
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-gradient); background-attachment: fixed; color: var(--text-color);
            margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; 
            padding: 20px; overflow-x: hidden; transition: background 0.4s ease;
        }

        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.03) 0px, rgba(0, 0, 0, 0.03) 1px, transparent 1px, transparent 2px);
            pointer-events: none; z-index: 100;
        }

        /* æ¡Œé¢ç‰ˆé è¨­å®¹å™¨å¯¬åº¦ */
        .main-container {
            width: 100%; max-width: 420px; display: flex; flex-direction: column; gap: var(--grid-gap); z-index: 10;
        }

        header {
            display: flex; justify-content: space-between; align-items: flex-end; padding: 0; margin-bottom: 5px;
        }

        .brand-title {
            font-size: 1.6rem; font-weight: 900; color: var(--header-text);
            text-transform: uppercase; font-style: italic; letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* =========================================
           [é–å®š] æ©«æ’ä¸»é¡Œçƒæ¨£å¼ (ç¦æ­¢è®Šå‹•)
           ========================================= */
        .skin-group { 
            display: flex !important; 
            flex-direction: row !important; 
            gap: 8px !important; 
            align-items: center !important; 
        }
        .skin-dot {
            width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--header-text);
            cursor: pointer; transition: var(--transition); opacity: 0.5;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 900;
            background: transparent; color: var(--header-text);
        }
        .skin-dot.active { 
            opacity: 1; transform: scale(1.1); background: var(--active-dot-bg); 
            color: var(--active-dot-text); box-shadow: 0 0 12px var(--glow-color); border-color: var(--active-dot-bg);
        }

        /* =========================================
           æ™‚é–“å€å¡Šä¸¦æ’ (æ¡Œé¢ç‰ˆé–å®š)
           ========================================= */
        .grid-row-container {
            display: grid; grid-template-columns: 1fr 1fr;
            column-gap: var(--grid-gap); row-gap: var(--grid-gap); width: 100%; box-sizing: border-box;
        }

        #startPanel { align-items: flex-start; }
        #endPanel { align-items: flex-end; }
        #endPanel .section-tag { justify-content: flex-end; }

        .section-tag {
            font-size: 0.75rem; font-weight: 900; color: var(--label-color);
            text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; 
            text-shadow: 1px 1px 1px rgba(0,0,0,0.1); width: 100%; transition: var(--transition);
        }

        .floating-panel {
            background-color: transparent; border: none; padding: 0; position: relative;
            display: flex; flex-direction: column; gap: 6px; transition: var(--transition); width: 100%;
        }

        /* =========================================
           [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆæ»¿ç‰ˆå›é­‚ (Width <= 420px)
           æ¨æ£„ Grid æ”¹ç”¨ Block ä¸¦å¼·åˆ¶ 100% å¯¬åº¦
           ========================================= */
        @media (max-width: 420px) {
            body { padding: 0 !important; }
            .main-container { 
                width: 100% !important; 
                max-width: none !important; 
                padding: 15px 15px !important; 
                box-sizing: border-box !important;
            }
            .grid-row-container { 
                display: block !important; /* æ‰‹æ©Ÿç‰ˆæ¨æ£„ Grid æ”¹ç”¨ Block */
            } 
            #startPanel, #endPanel { 
                width: 100% !important; /* å¼·åˆ¶é¢æ¿å¯¬åº¦ */
                align-items: flex-start !important; /* å…¨éƒ¨å·¦å°é½Š */
                margin-bottom: 12px;
            }
            #endPanel .section-tag { 
                justify-content: flex-start !important; /* æ‰‹æ©Ÿæ¨™ç±¤é å·¦ */
            }
            /* å…§éƒ¨è¼¸å…¥æ¡†çµ„ä»¶æ’æ»¿ */
            .input-group {
                width: 100% !important;
            }
        }

        /* =========================================
           æŒ‰éˆ•å‹•æ…‹èˆ‡é»æ“Šå›é¥‹ (Active)
           ========================================= */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--grid-gap); width: 100%; }

        .mode-btn {
            padding: 18px 5px; text-align: center; border-radius: 12px; cursor: pointer;
            font-size: 0.85rem; font-weight: 900; background: rgba(0,0,0,0.1);
            color: var(--text-color); border: 2px solid transparent; 
            transition: var(--transition); user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .mode-btn.active {
            background: var(--btn-primary); color: white; border-radius: 12px;
            border: var(--active-border); box-shadow: 0 0 18px var(--glow-color); 
        }

        /* [å›å½ˆå„ªåŒ–] è¬èƒ½é»æ“Šç¸®æ”¾ */
        .mode-btn:active, .btn-action:active, .btn-ocr:active, .skin-dot:active, .close-x:active {
            transform: scale(0.95) !important;
            filter: brightness(0.9);
            transition: transform 0.1s ease !important;
        }

        .btn-action {
            width: 100%; padding: 20px; border: none; cursor: pointer; font-size: 1.2rem;
            font-weight: 900; color: white; background: var(--btn-primary); border-radius: 15px;
            clip-path: var(--clip-path); transition: var(--transition); 
            box-shadow: 0 6px 0px rgba(0,0,0,0.1); user-select: none;
        }

        .btn-ocr {
            background: var(--pory-dark); color: white; padding: 14px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3); width: 100%; margin-top: 5px; font-weight: 800; cursor: pointer;
        }

        /* =========================================
           æ™‚é–“æ¡†è³ªæ„Ÿé–å®š (æ·±è‰²éœ§é¢ç™¼å…‰)
           ========================================= */
        #startTime, #endTime {
            background-color: var(--input-time-bg); color: var(--pory-cyan);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 1.35rem; letter-spacing: 1px; text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.15);
            text-shadow: 0 0 8px rgba(43, 192, 209, 0.5);
        }

        input, select, textarea {
            width: 100%; padding: 16px 15px; border: 2px solid transparent; border-radius: 12px;
            background-color: var(--input-bg); color: var(--input-text); font-size: 1.05rem;
            font-weight: 600; transition: var(--transition); box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            box-sizing: border-box; 
        }

        .dimmed { opacity: 0.4 !important; filter: grayscale(0.4); }

        /* =========================================
           [ä¿®å¾©] è¨­å®šé é¢é¢æ¿å…§éƒ¨ X éˆ•ç²¾ç¢ºå®šä½
           ========================================= */
        .config-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--overlay-bg); backdrop-filter: blur(25px);
            z-index: 1000; display: flex; justify-content: center; align-items: center;
            padding: 20px; overflow-y: auto; transition: var(--transition);
        }
        .config-panel { 
            width: 100%; max-width: 440px; background: transparent; 
            display: flex; flex-direction: column; gap: 20px; position: relative; 
        }
        .config-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; position: relative; min-height: 70px;
        }
        .config-header h2 { 
            margin: 0; font-style: italic; text-transform: uppercase; font-size: 2rem; 
            font-weight: 900; letter-spacing: 2px; color: var(--header-text); 
        }

        /* X éˆ•ï¼šçµ•å°å®šä½ç²¾å¯†éŒ¨å®šæ–¼é¢æ¿å³ä¸Šè§’å…§éƒ¨ */
        .close-x {
            width: 52px; height: 52px; background: #ef4444; color: white; border-radius: 50%;
            border: 4px solid #fff; display: flex; align-items: center; justify-content: center;
            font-size: 26px; font-weight: 900; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: var(--transition); 
            position: absolute; top: 0px; right: 0px; z-index: 10;
        }

        .status-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            background: var(--toast-bg); color: var(--toast-text); padding: 35px 25px; border-radius: 32px; 
            font-weight: 900; z-index: 5000; opacity: 0; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.4); border: 6px solid var(--pory-cyan);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 85%; max-width: 380px;
        }
        .status-toast.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="overlay-bg"></div>
<div id="statusToast" class="status-toast"></div>

<div class="main-container">
    <header>
        <div class="brand-title">ç„¡ç›¡ç«åŸŸï¼šç¥é­„ç™»è¨˜</div>
        <div class="skin-group">
            <div class="skin-dot" id="s-poryphone" onclick="setTheme('poryphone')">P</div>
            <div class="skin-dot" id="s-light" onclick="setTheme('light')">L</div>
            <div class="skin-dot" id="s-dark" onclick="setTheme('dark')">D</div>
        </div>
    </header>

    <!-- ä»‹é¢ç¸®æ”¾æ¯”ä¾‹ -->
    <div class="floating-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; position:relative;">
            <div class="section-tag">ä»‹é¢ç¸®æ”¾æ¯”ä¾‹</div>
            <b id="fsVal" style="font-size: 1rem; color: var(--pory-cyan); position:absolute; right:10px; top:-2px;">16px</b>
        </div>
        <input type="range" id="fsSlider" min="14" max="22" value="16" style="width: 100%;" oninput="updateFontSize(this.value)">
    </div>

    <!-- æ—¥æœŸé¸æ“‡ -->
    <div class="floating-panel">
        <div class="section-tag">æ—¥æœŸé¸æ“‡</div>
        <div class="input-group">
            <input type="date" id="dateIn" required>
        </div>
    </div>

    <!-- ä¸‹ç­é …ç›®è¨­å®š -->
    <div class="floating-panel">
        <div class="section-tag">ä¸‹ç­é …ç›®è¨­å®š</div>
        <div class="mode-grid">
            <div class="mode-btn active" id="m-regular" onclick="setMode('regular')">å¸¸è¦ä¸‹ç­</div>
            <div class="mode-btn" id="m-overtime" onclick="setMode('overtime')">ç‰¹å®šåŠ ç­</div>
            <div class="mode-btn" id="m-special" onclick="setMode('special')">ç‰¹æ®Šæ™‚æ®µ</div>
        </div>
    </div>

    <!-- é–‹å§‹èˆ‡çµæŸæ™‚é–“ -->
    <div class="grid-row-container">
        <div class="floating-panel" id="startPanel">
            <div class="section-tag">é–‹å§‹æ™‚é–“</div>
            <div class="input-group" id="startInputGroup">
                <input type="time" id="startTime" oninput="wakeUp('startInputGroup')">
            </div>
        </div>

        <div class="floating-panel" id="endPanel">
            <div class="section-tag">çµæŸæ™‚é–“</div>
            <div class="input-group" id="endInputGroup">
                <input type="time" id="endTime" required oninput="wakeUp('endInputGroup')">
            </div>
        </div>
    </div>

    <!-- äº‹ç”±èˆ‡æäº¤ -->
    <div class="floating-panel">
        <div class="section-tag">åŠ ç­äº‹ç”± / æ´»å‹•å…§å®¹</div>
        <div class="input-group">
            <div class="select-wrapper dimmed" id="reasonQuickWrapper">
                <select id="reasonQuick" onchange="handleQuickReasonChange()">
                </select>
            </div>
            <textarea id="reasonMain" rows="3" placeholder="è«‹åœ¨æ­¤è¼¸å…¥åŠ ç­ç´°ç¯€å…§å®¹..."></textarea>
            
            <button class="btn-ocr" onclick="document.getElementById('ocrInput').click()">
                ğŸ“· å•Ÿå‹•æ™ºæ…§æ–‡å­—è¾¨è­˜ (OCR)
            </button>
            <input type="file" id="ocrInput" accept="image/*" class="hidden" onchange="openCrop(this)">
        </div>

        <button class="btn-action" onclick="handleSubmit()">ä¸Šå‚³ç³»çµ±è³‡æ–™ç´€éŒ„</button>

        <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items: center;">
            <span style="font-size: 0.75rem; color: var(--header-text); opacity: 0.6; font-weight: 900; letter-spacing: 1px;">ç³»çµ± V1.08 [ç‚å¸æ­¦ç¥– Â· ç‰§ä¸»é½Šèš]</span>
            <button onclick="showConfig()" style="background: rgba(0,0,0,0.1); border: 2px solid var(--header-text); color: var(--header-text); padding: 10px 24px; border-radius: 50px; cursor: pointer; font-weight: 900; font-size: 0.8rem;">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>
    </div>
</div>

<!-- è¨­å®šé é¢ -->
<div id="configOverlay" class="config-overlay hidden">
    <div class="config-panel">
        <div class="config-header">
            <h2>ç³»çµ±è¨­å®š</h2>
            <div class="close-x" onclick="hideConfig()">âœ•</div>
        </div>
        
        <div class="floating-panel">
            <div class="section-tag">ä¸€èˆ¬åƒæ•¸è¨­å®š</div>
            <div class="input-group">
                <label style="font-size:0.75rem; font-weight:900; color:var(--label-color); margin-bottom: 2px;">ä½¿ç”¨è€…å§“å</label>
                <input type="text" id="cfgName" placeholder="ä¾‹å¦‚ï¼šç‰§å¡µã€æ´›ç’ƒ">
            </div>
            <div class="input-group" style="margin-top: 5px;">
                <label style="font-size:0.75rem; font-weight:900; color:var(--label-color); margin-bottom: 2px;">GAS API ä¼ºæœå™¨ç¶²å€</label>
                <input type="text" id="cfgUrl" placeholder="https://script.google.com/...">
            </div>
            <div class="input-group" style="margin-top: 5px;">
                <label style="font-size:0.75rem; font-weight:900; color:var(--label-color); margin-bottom: 2px;">å¸¸ç”¨åŠ ç­äº‹ç”± (ä»¥é€—è™Ÿåˆ†éš”)</label>
                <textarea id="cfgReasons" rows="8" placeholder="è¼¸å…¥äº‹ç”±ï¼Œæ¯å€‹ä»¥é€—è™Ÿåˆ†éš”..."></textarea>
            </div>
            <button class="btn-action" style="margin-top: 10px;" onclick="saveConfig()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
        </div>

        <div class="floating-panel" style="margin-top: 5px;">
            <div class="section-tag" style="color: var(--warning-red);">ç®¡ç†å“¡é€²éšå·¥å…·</div>
            <button class="btn-action" style="background: #ef4444; font-size: 1rem; padding: 15px; clip-path: none;" onclick="confirmReset()">
                âš ï¸ é‡è¨­ Google è©¦ç®—è¡¨ç¯„æœ¬
            </button>
        </div>
    </div>
</div>

<!-- OCR åœ–ç‰‡è£åˆ‡å½ˆçª— -->
<div id="cropModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:3000; display:flex; flex-direction:column;">
    <div style="flex:1; position:relative; overflow:hidden;">
        <img id="cropImg" style="max-width:100%;">
    </div>
    <div style="padding: 20px; background:#fff; display:flex; gap:10px;">
        <button class="btn-action" style="background:#666; clip-path:none;" onclick="closeCrop()">å–æ¶ˆ</button>
        <button class="btn-action" id="ocrGo" style="clip-path:none;" onclick="doOCR()">ç¢ºå®šè¾¨è­˜</button>
    </div>
</div>

<script>
    /* JavaScript å®Œå…¨ä¿ç•™åŸå§‹é‚è¼¯ï¼Œç¢ºä¿ ID èˆ‡åŠŸèƒ½ 100% æ­£å¸¸ */
    const state = { cropper: null, mode: 'regular' };
    const el = {
        toast: document.getElementById('statusToast'),
        overlayBg: document.getElementById('overlay-bg'),
        fsSlider: document.getElementById('fsSlider'),
        fsVal: document.getElementById('fsVal'),
        date: document.getElementById('dateIn'),
        start: document.getElementById('startTime'),
        end: document.getElementById('endTime'),
        startInputGroup: document.getElementById('startInputGroup'),
        endInputGroup: document.getElementById('endInputGroup'),
        reason: document.getElementById('reasonMain'),
        reasonQuick: document.getElementById('reasonQuick'),
        reasonQuickWrapper: document.getElementById('reasonQuickWrapper'),
        cfgOverlay: document.getElementById('configOverlay'),
        cfgName: document.getElementById('cfgName'),
        cfgUrl: document.getElementById('cfgUrl'),
        cfgReasons: document.getElementById('cfgReasons'),
        cropModal: document.getElementById('cropModal'),
        cropImg: document.getElementById('cropImg'),
        ocrGo: document.getElementById('ocrGo')
    };

    window.onload = () => {
        const url = localStorage.getItem('gas_url');
        const theme = localStorage.getItem('theme') || 'poryphone';
        const fontSize = localStorage.getItem('base_font_size') || '16';
        const reasons = localStorage.getItem('custom_reasons') || "äº¤æ¥è¼ªå€¼,ç™¾è²¨é¡è™•ç†,æ•™ç§‘æ›¸è™•ç†,æ•¸ä½å°åˆ·,è‡¨æ™‚æ€¥ä»¶";
        setTheme(theme);
        updateFontSize(fontSize);
        el.fsSlider.value = fontSize;
        el.cfgName.value = localStorage.getItem('user_name') || '';
        el.cfgUrl.value = url || '';
        el.cfgReasons.value = reasons;
        renderReasons(reasons);
        const now = new Date();
        el.date.valueAsDate = now;
        el.end.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        el.endInputGroup.classList.add('dimmed');
        if (!url) showConfig();
        setMode('regular');
    };

    window.setTheme = (t) => {
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('theme', t);
        document.querySelectorAll('.skin-dot').forEach(d => d.classList.toggle('active', d.id === 's-' + t));
    };

    window.updateFontSize = (v) => {
        document.documentElement.style.setProperty('--base-font-size', v + 'px');
        el.fsVal.textContent = v + 'px';
        localStorage.setItem('base_font_size', v);
    };

    window.setMode = (m) => {
        state.mode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.id === 'm-' + m));
        const stdOff = localStorage.getItem('std_off') || '17:30';
        const stdStart = localStorage.getItem('std_start') || '08:30';
        if (m === 'regular') {
            el.startInputGroup.classList.add('dimmed');
            el.start.value = stdOff;
        } else {
            el.startInputGroup.classList.remove('dimmed');
            el.start.value = (m === 'overtime') ? stdOff : stdStart;
        }
    };

    window.wakeUp = (id) => {
        document.getElementById(id).classList.remove('dimmed');
    };

    window.handleQuickReasonChange = () => {
        if(el.reasonQuick.value) {
            el.reason.value = el.reasonQuick.value;
            el.reasonQuickWrapper.classList.remove('dimmed');
        }
    };

    window.renderReasons = (str) => {
        el.reasonQuick.innerHTML = '<option value="" disabled selected>-- å¿«é€Ÿé¸æ“‡äº‹ç”± --</option>';
        str.split(/[,ï¼Œ\n]+/).map(s => s.trim()).filter(s => s).forEach(r => {
            const o = document.createElement('option'); o.value = o.textContent = r;
            el.reasonQuick.appendChild(o);
        });
    };

    window.showConfig = () => el.cfgOverlay.classList.remove('hidden');
    window.hideConfig = () => el.cfgOverlay.classList.add('hidden');

    window.saveConfig = () => {
        localStorage.setItem('gas_url', el.cfgUrl.value.trim());
        localStorage.setItem('user_name', el.cfgName.value.trim());
        localStorage.setItem('custom_reasons', el.cfgReasons.value);
        renderReasons(el.cfgReasons.value);
        toast('âœ… è¨­å®šå·²æˆåŠŸå„²å­˜');
        setTimeout(hideConfig, 800);
    };

    window.confirmReset = () => {
        const url = localStorage.getItem('gas_url');
        if(!url) return alert('è«‹å…ˆè¨­å®š API ç¶²å€');
        const content = `
            <div style="font-size: 4rem; color: #ef4444; margin-bottom: 10px;">âš ï¸</div>
            <div style="font-size: 1.5rem; color: #ef4444; margin-bottom: 5px;">åš´é‡è­¦å‘Š</div>
            <div style="font-size: 1rem; color: #666; line-height: 1.6;">ç¢ºå®šè¦é‡è¨­ç¯„æœ¬å—ï¼Ÿ<br>æ­¤å‹•ä½œå°‡æœƒè¦†è“‹é›²ç«¯å®šç¾©ä¸”ç„¡æ³•æ’¤éŠ·ï¼</div>
            <div style="display: flex; gap: 15px; width: 100%; margin-top: 20px;">
                <button style="flex:1; padding:15px; border-radius:12px; border:none; background:#eee; font-weight:900; cursor:pointer;" onclick="closeToast()">å–æ¶ˆè¿”å›</button>
                <button style="flex:1; padding:15px; border-radius:12px; border:none; background:#ef4444; color:white; font-weight:900; cursor:pointer;" onclick="executeReset()">ç¢ºèªé‡è¨­</button>
            </div>`;
        showSpecialModal(content, true);
    };

    window.executeReset = () => {
        const url = localStorage.getItem('gas_url');
        closeToast();
        toast('â³ é‡è¨­è«‹æ±‚å‚³é€ä¸­...');
        const fd = new FormData(); fd.append('action', 'reset_template');
        fetch(url, { method: 'POST', body: fd })
            .then(r => r.json()).then(d => {
                if(d.result === 'success' || d.status === 'success') {
                    toast('âœ… ç¯„æœ¬é‡è¨­æˆåŠŸ');
                    setTimeout(() => {
                        alert('âœ… ç¯„æœ¬å·²æˆåŠŸé‡è¨­ï¼\n\nä¸‹æ¬¡å»ºç«‹æ–°æœˆä»½æ™‚å°‡å¥—ç”¨æ–°æ ¼å¼ã€‚\n(èˆŠçš„æœˆä»½éœ€è¦æ‰‹å‹•åˆªé™¤å·¥ä½œè¡¨æ‰æœƒç”Ÿæ•ˆ)');
                    }, 800);
                } else {
                    alert('âŒ é‡è¨­å¤±æ•—: ' + (d.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            }).catch(() => alert('âŒ é€£ç·šç•°å¸¸'));
    };

    window.handleSubmit = () => {
        const url = localStorage.getItem('gas_url');
        if(!url) return toast('âš ï¸ è«‹å…ˆå®Œæˆç³»çµ±è¨­å®š');
        if(!el.reason.value) return toast('âš ï¸ è«‹å¡«å¯«åŠ ç­å…§å®¹');
        toast('ğŸ“¡ æ­£åœ¨ä¸Šå‚³è‡³é›²ç«¯...');
        const fd = new FormData();
        fd.append('action', 'submit');
        fd.append('date', el.date.value);
        fd.append('name', localStorage.getItem('user_name') || 'æœªå‘½å');
        fd.append('startTime', state.mode === 'regular' && el.startInputGroup.classList.contains('dimmed') ? '' : el.start.value);
        fd.append('endTime', el.end.value);
        fd.append('reason', el.reason.value);
        fetch(url, { method: 'POST', body: fd })
            .then(r => r.json()).then(d => {
                if(d.result === 'success' || d.status === 'success') {
                    toast('âœ¨ ç™»è¨˜æˆåŠŸï¼');
                    el.reason.value = '';
                    el.endInputGroup.classList.add('dimmed');
                    el.reasonQuickWrapper.classList.add('dimmed');
                    if(state.mode === 'regular') el.startInputGroup.classList.add('dimmed');
                } else toast('âŒ ç™»è¨˜å¤±æ•—');
            }).catch(() => toast('âŒ ç¶²è·¯é€šè¨ŠéŒ¯èª¤'));
    };

    function toast(txt) {
        el.toast.innerHTML = txt;
        el.toast.className = 'status-toast show';
        el.overlayBg.classList.add('show');
        setTimeout(closeToast, 2200);
    }

    function showSpecialModal(html, isWarning = false) {
        el.toast.innerHTML = html;
        el.toast.className = 'status-toast show' + (isWarning ? ' warning' : '');
        el.overlayBg.classList.add('show');
    }

    window.closeToast = () => {
        el.toast.classList.remove('show');
        el.overlayBg.classList.remove('show');
    };

    window.openCrop = (input) => {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            el.cropImg.src = e.target.result;
            el.cropModal.classList.remove('hidden');
            if(state.cropper) state.cropper.destroy();
            state.cropper = new Cropper(el.cropImg, { viewMode: 1, autoCropArea: 0.8 });
        };
        reader.readAsDataURL(input.files[0]);
    };

    window.closeCrop = () => { el.cropModal.classList.add('hidden'); if(state.cropper) state.cropper.destroy(); };

    window.doOCR = () => {
        const url = localStorage.getItem('gas_url');
        if(!url) return alert('è«‹å…ˆè¨­å®š API');
        el.ocrGo.textContent = 'è¾¨è­˜ä¸­...';
        const b64 = state.cropper.getCroppedCanvas({maxWidth: 800}).toDataURL('image/jpeg', 0.7).split(',')[1];
        const fd = new FormData(); fd.append('action', 'ocr'); fd.append('image', b64);
        fetch(url, { method: 'POST', body: fd })
            .then(r => r.json()).then(d => {
                const res = d.text || (d.data ? d.data.text : "");
                if(res) { el.reason.value = res; toast('âœ¨ è¾¨è­˜æˆåŠŸ'); }
                else toast('âŒ ç„¡æ³•è¾¨è­˜');
            }).finally(() => { el.ocrGo.textContent = 'ç¢ºå®šè¾¨è­˜'; closeCrop(); });
    };
</script>
</body>
</html>
